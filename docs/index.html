<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="cache-control" content="no-cache, no-store, must-revalidate">
  <meta name="version" content="2.0.1-20260126">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f0f2f5; color: #333; font-size: 13px; }

    .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .header h1 { font-size: 16px; font-weight: 600; }
    .header-actions { display: flex; gap: 8px; align-items: center; }
    .btn { padding: 7px 14px; border: none; border-radius: 5px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; position: relative; }
    .btn-primary { background: #4361ee; color: #fff; }
    .btn-primary:hover { background: #3651d4; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(67,97,238,0.3); }
    .btn-ghost { background: rgba(255,255,255,0.1); color: #fff; }
    .btn-ghost:hover { background: rgba(255,255,255,0.2); }
    .btn-success { background: #27ae60; color: #fff; }
    .btn-danger { background: #e74c3c; color: #fff; }

    /* Tooltips */
    [data-tooltip] { cursor: help; }
    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: #1a1a2e;
      color: #fff;
      font-size: 11px;
      white-space: nowrap;
      border-radius: 6px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    [data-tooltip]:hover::before {
      content: '';
      position: absolute;
      bottom: 115%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1a1a2e;
      z-index: 1000;
    }

    .filtros { background: #fff; padding: 12px 20px; border-bottom: 1px solid #e0e0e0; display: flex; gap: 16px; align-items: center; flex-wrap: wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .filtro-grupo { display: flex; align-items: center; gap: 6px; }
    .filtro-grupo label { font-size: 11px; color: #666; font-weight: 500; }
    .filtro-grupo select, .filtro-grupo input { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }

    .resumo-bar { display: flex; gap: 20px; padding: 12px 20px; background: #fff; border-bottom: 1px solid #e0e0e0; flex-wrap: wrap; }
    .resumo-item { display: flex; align-items: center; gap: 6px; }
    .resumo-num { font-weight: 700; font-size: 16px; }
    .resumo-label { font-size: 11px; color: #888; }

    .main { display: flex; height: calc(100vh - 140px); }

    /* LISTA DE VENDEDORES */
    .sidebar { width: 240px; background: #fff; border-right: 1px solid #e0e0e0; overflow-y: auto; flex-shrink: 0; }
    .sidebar-title { padding: 12px 16px; font-weight: 600; font-size: 12px; color: #666; border-bottom: 1px solid #eee; background: #fafafa; }
    .vend-item { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.2s; }
    .vend-item:hover { background: #f5f7fa; }
    .vend-item.ativo { background: #e8f0fe; border-left: 3px solid #4361ee; }
    .vend-nome { font-weight: 600; font-size: 13px; margin-bottom: 2px; }
    .vend-info { font-size: 11px; color: #888; }
    .vend-valor { color: #4361ee; font-weight: 600; }
    .vend-alertas { color: #e74c3c; font-size: 10px; }

    /* AREA DE PROPOSTAS */
    .propostas-area { flex: 1; overflow-y: auto; padding: 16px 20px; }
    .propostas-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .propostas-header h2 { font-size: 15px; font-weight: 600; }
    .ordenar select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }

    /* CARDS DE PROPOSTA */
    .propostas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 14px; }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid #e8e8e8;
      position: relative;
    }
    .card:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.12); transform: translateY(-3px); }
    .card.urgente { border-left: 4px solid #e74c3c; background: linear-gradient(to right, #fee2e2 0%, #fff 10%); }
    .card.alta-prob { border-left: 4px solid #27ae60; }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .card-num { font-size: 11px; color: #888; font-weight: 500; }
    .card-prob {
      padding: 4px 10px;
      border-radius: 14px;
      font-size: 11px;
      font-weight: 700;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card-cliente {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-valor { font-size: 20px; font-weight: 700; color: #4361ee; margin-bottom: 10px; }

    .card-etapa {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 5px;
      font-size: 10px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 10px;
    }

    .card-info { font-size: 11px; color: #666; margin-bottom: 6px; }
    .card-info span { margin-right: 12px; }

    .card-alertas { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
    .alerta {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 600;
    }
    .alerta-red { background: #fee2e2; color: #b91c1c; }
    .alerta-yellow { background: #fef3c7; color: #92400e; }

    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0; }
    .card-vendedor { font-size: 11px; color: #888; }
    .card-contato { font-size: 10px; color: #888; }

    /* BADGES */
    .badge-recorrente {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      color: #166534;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      box-shadow: 0 1px 3px rgba(22,101,52,0.2);
    }

    .badge-match {
      background: #e0f2fe;
      color: #0369a1;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 8px;
      font-weight: 600;
      margin-left: 4px;
    }

    .badge-cliente-fiel {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 8px;
      font-weight: 700;
    }

    /* MODAL */
    .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: flex-start; padding: 40px 20px; overflow-y: auto; }
    .modal-bg.aberto { display: flex; }
    .modal { background: #fff; border-radius: 12px; width: 100%; max-width: 850px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-header { padding: 18px 24px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
    .modal-header h2 { font-size: 17px; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #888; }
    .modal-close:hover { color: #333; }
    .modal-body { padding: 24px; max-height: 75vh; overflow-y: auto; }

    .prop-resumo { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px; }
    .prop-box { background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%); border-radius: 10px; padding: 14px; border: 1px solid #e8e8e8; }
    .prop-box-label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 6px; font-weight: 600; letter-spacing: 0.5px; }
    .prop-box-value { font-size: 15px; font-weight: 600; }
    .prop-box-value.grande { font-size: 24px; color: #4361ee; font-weight: 700; }

    .fatores-prob { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 10px; padding: 14px; margin-bottom: 18px; border: 1px solid #bae6fd; }
    .fatores-prob h4 { font-size: 13px; color: #0369a1; margin-bottom: 10px; font-weight: 600; }
    .fator-item { display: flex; justify-content: space-between; font-size: 11px; padding: 6px 0; border-bottom: 1px solid #e0f2fe; }
    .fator-item:last-child { border-bottom: none; }
    .fator-impacto { font-weight: 700; font-size: 12px; }
    .fator-impacto.positivo { color: #16a34a; }
    .fator-impacto.negativo { color: #dc2626; }

    .etapas-btns { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .etapa-btn {
      padding: 10px 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: #fff;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .etapa-btn:hover { border-color: #4361ee; transform: translateY(-1px); }
    .etapa-btn.atual { border-color: #4361ee; background: #e8f0fe; box-shadow: 0 2px 6px rgba(67,97,238,0.2); }

    .secao { margin-bottom: 24px; }
    .secao-titulo { font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: #1a1a2e; }
    .badge-ia { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); color: #0369a1; padding: 3px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; }

    .campo { margin-bottom: 14px; }
    .campo label { display: block; font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 500; }
    .campo input, .campo textarea, .campo select { width: 100%; padding: 11px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
    .campo input:focus, .campo textarea:focus, .campo select:focus { outline: none; border-color: #4361ee; box-shadow: 0 0 0 3px rgba(67,97,238,0.1); }
    .campo textarea { min-height: 80px; resize: vertical; }

    .acoes-rapidas { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 18px; }
    .acao-btn {
      padding: 14px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }
    .acao-btn:hover { border-color: #4361ee; background: #f8f9ff; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .acao-btn-icon { font-size: 20px; margin-bottom: 6px; }
    .acao-btn-label { font-size: 13px; font-weight: 600; }
    .acao-btn-desc { font-size: 10px; color: #888; margin-top: 2px; }

    .ia-box { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #bae6fd; border-radius: 10px; padding: 16px; margin-bottom: 18px; }
    .ia-box-content { font-size: 13px; line-height: 1.7; white-space: pre-wrap; }
    .ia-box-actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }

    .historico { background: #f8f9fa; border-radius: 8px; padding: 14px; max-height: 180px; overflow-y: auto; font-size: 11px; line-height: 1.7; white-space: pre-wrap; color: #666; border: 1px solid #e8e8e8; }

    .btn-salvar { width: 100%; padding: 14px; background: linear-gradient(135deg, #4361ee 0%, #3651d4 100%); color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 16px; box-shadow: 0 4px 12px rgba(67,97,238,0.3); transition: all 0.2s; }
    .btn-salvar:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(67,97,238,0.4); }

    .btn-finalizar { padding: 12px 18px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
    .btn-ganho { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #166534; }
    .btn-ganho:hover { background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%); transform: translateY(-2px); }
    .btn-perdido { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; }
    .btn-perdido:hover { background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%); transform: translateY(-2px); }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: #888; }
    .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #ddd; border-top-color: #4361ee; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Cliente Info */
    .cliente-info {
      background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
      border: 2px solid #fde047;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 18px;
    }
    .cliente-info h4 { font-size: 13px; color: #854d0e; margin-bottom: 8px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
    .cliente-info p { font-size: 12px; color: #713f12; margin: 4px 0; }
    .cliente-info .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .cliente-info .stat-box { background: rgba(255,255,255,0.5); padding: 8px; border-radius: 6px; text-align: center; }
    .cliente-info .stat-num { font-size: 16px; font-weight: 700; color: #92400e; }
    .cliente-info .stat-label { font-size: 9px; color: #92400e; text-transform: uppercase; margin-top: 2px; }

    /* Match Score */
    .match-score {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #e0f2fe;
      color: #0369a1;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 600;
    }

    /* Dados Enriquecidos */
    .dados-enriquecidos {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }
    .dados-enriquecidos h5 { font-size: 11px; color: #166534; margin-bottom: 6px; font-weight: 600; }
    .dados-enriquecidos p { font-size: 10px; color: #15803d; margin: 2px 0; }
  </style>
</head>
<body>

<div class="header">
  <h1>üéØ CRM PILI - Gerente Comercial IA</h1>
  <div class="header-actions">
    <button class="btn btn-ghost" onclick="mostrarDashboard()" data-tooltip="Dashboard Analytics com m√©tricas e gr√°ficos do pipeline">üìà Dashboard</button>
    <button class="btn btn-ghost" onclick="mostrarRelatorios()" data-tooltip="Relat√≥rios gerenciais">üìä Relat√≥rios</button>
    <button class="btn btn-ghost" onclick="sincronizar()" data-tooltip="Importar novas propostas do formul√°rio Google">üîÑ Sincronizar</button>
    <button class="btn btn-primary" onclick="carregar()" data-tooltip="Recarregar dados da planilha">‚ö° Atualizar</button>
    <button class="btn btn-ghost" onclick="mostrarAjuda()" data-tooltip="Guia completo de como usar o sistema">‚ùì Ajuda</button>
  </div>
</div>

<div class="resumo-bar">
  <div class="resumo-item">
    <span class="resumo-num" id="rTotal">-</span>
    <span class="resumo-label">ativas</span>
  </div>
  <div class="resumo-item">
    <span class="resumo-num" id="rValor" style="color:#4361ee">-</span>
    <span class="resumo-label">pipeline</span>
  </div>
  <div class="resumo-item">
    <span class="resumo-num" id="rGanhos" style="color:#16a34a">-</span>
    <span class="resumo-label">ganhos</span>
  </div>
  <div class="resumo-item">
    <span class="resumo-num" id="rTaxa">-</span>
    <span class="resumo-label">convers√£o</span>
  </div>
  <div class="resumo-item">
    <span class="resumo-num" id="rUrgentes" style="color:#e74c3c">-</span>
    <span class="resumo-label">urgentes</span>
  </div>
  <div class="resumo-item">
    <span class="resumo-num" id="rMediaDias">-</span>
    <span class="resumo-label">dias no funil</span>
  </div>
</div>

<div class="filtros">
  <div class="filtro-grupo">
    <label>Etapa:</label>
    <select id="filtroEtapa" onchange="aplicarFiltros()">
      <option value="">Todas</option>
      <option value="NOVO">Novo</option>
      <option value="CONTATO_FEITO">Contato Feito</option>
      <option value="AGUARDANDO_RETORNO">Aguardando Retorno</option>
      <option value="NEGOCIACAO">Em Negocia√ß√£o</option>
      <option value="PROPOSTA_ENVIADA">Proposta Enviada</option>
      <option value="FECHAMENTO">Fechamento</option>
      <option value="GANHO">‚úÖ Ganho</option>
      <option value="PERDIDO">‚ùå Perdido</option>
    </select>
  </div>
  <div class="filtro-grupo">
    <label>Prob:</label>
    <select id="filtroProb" onchange="aplicarFiltros()">
      <option value="">Todas</option>
      <option value="alta">Alta (70%+)</option>
      <option value="media">M√©dia (40-69%)</option>
      <option value="baixa">Baixa (-40%)</option>
    </select>
  </div>
  <div class="filtro-grupo">
    <label>Cliente:</label>
    <select id="filtroCliente" onchange="aplicarFiltros()">
      <option value="">Todos</option>
      <option value="recorrente">Recorrentes</option>
      <option value="novo">Novos</option>
      <option value="fiel">Fi√©is (3+)</option>
    </select>
  </div>
  <div class="filtro-grupo">
    <label>Alertas:</label>
    <select id="filtroAlerta" onchange="aplicarFiltros()">
      <option value="">Todos</option>
      <option value="vencida">Vencidas</option>
      <option value="semcontato">Sem Contato</option>
      <option value="atrasada">A√ß√£o Atrasada</option>
      <option value="estagnada">Estagnadas</option>
    </select>
  </div>
  <div class="filtro-grupo">
    <label>Buscar:</label>
    <input type="text" id="filtroBusca" placeholder="Cliente ou #proposta" onkeyup="aplicarFiltros()">
  </div>
</div>

<div class="main">
  <div class="sidebar">
    <div class="sidebar-title">VENDEDORES</div>
    <div id="listaVendedores"><div class="loading"><div class="loading-spinner"></div></div></div>
  </div>

  <div class="propostas-area">
    <div class="propostas-header">
      <h2 id="areaTitle">Todas as Propostas</h2>
      <div class="ordenar">
        <select id="ordenacao" onchange="aplicarFiltros()">
          <option value="prob">‚ö° Maior Probabilidade</option>
          <option value="valor">üí∞ Maior Valor</option>
          <option value="vencer">‚è∞ Vence Antes</option>
          <option value="contato">üìû Mais Tempo Sem Contato</option>
          <option value="recente">üÜï Mais Recente</option>
        </select>
      </div>
    </div>
    <div class="propostas-grid" id="propostasGrid">
      <div class="loading"><div class="loading-spinner"></div> Carregando propostas...</div>
    </div>
  </div>
</div>

<!-- MODAL PROPOSTA -->
<div class="modal-bg" id="modalProposta" onclick="if(event.target===this)fecharModal()">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalTitulo">Proposta</h2>
      <button class="modal-close" onclick="fecharModal()">&times;</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- MODAL RELAT√ìRIOS -->
<div class="modal-bg" id="modalRelatorios" onclick="if(event.target===this)fecharRelatorios()">
  <div class="modal" style="max-width:500px">
    <div class="modal-header">
      <h2>üìä Relat√≥rios Gerenciais</h2>
      <button class="modal-close" onclick="fecharRelatorios()">&times;</button>
    </div>
    <div class="modal-body" style="padding:30px">
      <!-- FILTROS DE PER√çODO -->
      <div style="margin-bottom:25px;padding:15px;background:#f8f9ff;border-radius:8px">
        <div style="font-weight:600;margin-bottom:10px;font-size:14px">üìÖ Per√≠odo de An√°lise</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px">Data Inicial:</label>
            <input type="date" id="dataInicioRelatorio" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px">
          </div>
          <div>
            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px">Data Final:</label>
            <input type="date" id="dataFimRelatorio" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px">
          </div>
        </div>
        <div style="margin-top:8px;font-size:11px;color:#666">
          Deixe em branco para incluir todas as propostas
        </div>
      </div>

      <!-- STATUS A INCLUIR -->
      <div style="margin-bottom:25px;padding:15px;background:#f8f9ff;border-radius:8px">
        <div style="font-weight:600;margin-bottom:10px;font-size:14px">üìã Status a Incluir</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:13px">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
            <input type="checkbox" id="incluirAbertos" checked style="cursor:pointer"> Abertas
          </label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
            <input type="checkbox" id="incluirGanhos" style="cursor:pointer"> Ganhos
          </label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
            <input type="checkbox" id="incluirPerdidos" style="cursor:pointer"> Perdidos
          </label>
        </div>
      </div>

      <!-- FILTROS DE VENDEDOR E ESTADO -->
      <div style="margin-bottom:25px;padding:15px;background:#f8f9ff;border-radius:8px">
        <div style="font-weight:600;margin-bottom:10px;font-size:14px">üë• Filtrar por Vendedor e Estado</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px">Vendedor:</label>
            <select id="filtroVendedorRelatorio" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px">
              <option value="">Todos os vendedores</option>
            </select>
          </div>
          <div>
            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px">Estado:</label>
            <select id="filtroEstadoRelatorio" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px">
              <option value="">Todos os estados</option>
            </select>
          </div>
        </div>
      </div>

      <!-- BOT√ÉO RELAT√ìRIO FILTRADO -->
      <div style="margin-bottom:25px">
        <button class="btn btn-primary" onclick="gerarRelatorioComFiltrosModal()" style="width:100%;padding:15px;font-size:14px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px">
          üìä Gerar Relat√≥rio com Filtros Acima
        </button>
        <div style="margin-top:8px;font-size:11px;color:#666;text-align:center">
          Gera relat√≥rio Excel usando per√≠odo, status, vendedor e estado selecionados
        </div>
      </div>

      <div style="display:grid;gap:15px">
        <button id="btnRelatorioVendedor" onclick="gerarRelatorioVendedor()" style="padding:20px;border:2px solid #4361ee;background:#fff;border-radius:10px;cursor:pointer;text-align:left;transition:all 0.2s" onmouseover="this.style.background='#f8f9ff';this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#fff';this.style.transform='translateY(0)'">
          <div style="font-size:20px;margin-bottom:8px">üë• Por Vendedor</div>
          <div style="font-size:13px;color:#666">Pipeline de cada vendedor com propostas, valores e status</div>
        </button>

        <button id="btnRelatorioEstado" onclick="gerarRelatorioEstado()" style="padding:20px;border:2px solid #4361ee;background:#fff;border-radius:10px;cursor:pointer;text-align:left;transition:all 0.2s" onmouseover="this.style.background='#f8f9ff';this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#fff';this.style.transform='translateY(0)'">
          <div style="font-size:20px;margin-bottom:8px">üó∫Ô∏è Por Estado</div>
          <div style="font-size:13px;color:#666">Distribui√ß√£o geogr√°fica das propostas e valores por regi√£o</div>
        </button>

        <button id="btnRelatorioCompleto" onclick="gerarRelatorioCompleto()" style="padding:20px;border:2px solid #27ae60;background:#fff;border-radius:10px;cursor:pointer;text-align:left;transition:all 0.2s" onmouseover="this.style.background='#f0fdf4';this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#fff';this.style.transform='translateY(0)'">
          <div style="font-size:20px;margin-bottom:8px">üìà Relat√≥rio Executivo</div>
          <div style="font-size:13px;color:#666">Vis√£o completa: resumo + vendedores + estados + performance</div>
        </button>

        <button id="btnRelatorioAtividades" onclick="gerarRelatorioAtividades()" style="padding:20px;border:2px solid #f39c12;background:#fff;border-radius:10px;cursor:pointer;text-align:left;transition:all 0.2s" onmouseover="this.style.background='#fffbf0';this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#fff';this.style.transform='translateY(0)'">
          <div style="font-size:20px;margin-bottom:8px">üìã Atividades do Pipeline</div>
          <div style="font-size:13px;color:#666">Hist√≥rico de a√ß√µes, mudan√ßas de etapa e intera√ß√µes por per√≠odo</div>
        </button>
      </div>

      <div style="margin-top:20px;padding:12px;background:#e8f0fe;border-radius:6px;font-size:12px">
        <strong>üí° DICA:</strong> Use os filtros acima para analisar per√≠odos espec√≠ficos e incluir propostas ganhas/perdidas
      </div>
    </div>
  </div>
</div>

<!-- MODAL AJUDA -->
<div class="modal-bg" id="modalAjuda" onclick="if(event.target===this)fecharAjuda()">
  <div class="modal">
    <div class="modal-header">
      <h2>üìñ Guia R√°pido - Como Usar o CRM</h2>
      <button class="modal-close" onclick="fecharAjuda()">&times;</button>
    </div>
    <div class="modal-body" style="font-size:13px;line-height:1.6">
      <h3 style="color:#4361ee;margin-bottom:10px">üöÄ IN√çCIO R√ÅPIDO</h3>
      <p><strong>1. SINCRONIZE OS DADOS</strong></p>
      <p style="margin-left:20px">Clique em "üîÑ Sincronizar" para importar propostas do formul√°rio Google</p>

      <p><strong>2. VISUALIZE O PIPELINE</strong></p>
      <p style="margin-left:20px">‚Ä¢ <strong>Sidebar esquerda:</strong> Lista de vendedores com total de propostas e alertas<br>
      ‚Ä¢ <strong>√Årea principal:</strong> Cards das propostas organizadas por probabilidade<br>
      ‚Ä¢ <strong>Filtros no topo:</strong> Filtre por etapa, probabilidade, cliente ou alertas</p>

      <p><strong>3. ANALISE UMA PROPOSTA</strong></p>
      <p style="margin-left:20px">Clique em qualquer card para abrir os detalhes completos</p>

      <hr style="margin:20px 0;border:none;border-top:1px solid #eee">

      <h3 style="color:#4361ee;margin-bottom:10px">ü§ñ RECURSOS DE IA</h3>
      <p>Dentro de cada proposta, voc√™ tem 4 bot√µes de IA:</p>

      <p><strong>üîç Analisar & Gerar Subs√≠dios</strong></p>
      <p style="margin-left:20px;font-size:12px;color:#666">
      ‚úÖ O que cobrar do vendedor AGORA<br>
      ‚úÖ Script completo de liga√ß√£o para o vendedor usar<br>
      ‚úÖ Mensagem WhatsApp pronta para copiar<br>
      ‚úÖ Cronograma de cobran√ßa (pr√≥ximos 7 dias)<br>
      ‚úÖ Arsenal de argumentos para obje√ß√µes
      </p>

      <p><strong>üè¢ Dados do Cliente</strong></p>
      <p style="margin-left:20px;font-size:12px;color:#666">
      Busca CNPJ automaticamente e retorna:<br>
      ‚Ä¢ Raz√£o social, porte, capital social<br>
      ‚Ä¢ Setor e atividades<br>
      ‚Ä¢ An√°lise de FIT com produto<br>
      ‚Ä¢ Capacidade estimada de armazenagem (se agro)<br>
      ‚Ä¢ Estrat√©gia de abordagem personalizada
      </p>

      <p><strong>üí¨ Gerar Mensagem p/ Vendedor</strong></p>
      <p style="margin-left:20px;font-size:12px;color:#666">
      Cria mensagem WhatsApp pronta para enviar ao cliente,<br>
      personalizada com hist√≥rico e contexto da proposta
      </p>

      <p><strong>üéØ Responder Obje√ß√£o</strong></p>
      <p style="margin-left:20px;font-size:12px;color:#666">
      Digite a obje√ß√£o que o cliente deu e receba:<br>
      ‚Ä¢ Script completo de resposta<br>
      ‚Ä¢ Argumentos t√©cnicos com dados<br>
      ‚Ä¢ Treinamento pontual para o vendedor<br>
      ‚Ä¢ Plano B se primeira abordagem falhar
      </p>

      <hr style="margin:20px 0;border:none;border-top:1px solid #eee">

      <h3 style="color:#4361ee;margin-bottom:10px">üìä INDICADORES IMPORTANTES</h3>
      <p style="margin-left:20px;font-size:12px">
      <strong>Cards coloridos:</strong><br>
      ‚Ä¢ <span style="color:#27ae60">‚ñ†</span> Verde = Alta probabilidade (70%+)<br>
      ‚Ä¢ <span style="color:#f39c12">‚ñ†</span> Amarelo = M√©dia (40-69%)<br>
      ‚Ä¢ <span style="color:#e74c3c">‚ñ†</span> Vermelho = Baixa (-40%) ou URGENTE<br><br>

      <strong>Badges especiais:</strong><br>
      ‚Ä¢ üîÅ RECORRENTE = Cliente j√° comprou antes<br>
      ‚Ä¢ ‚≠ê FIEL = Cliente com 3+ compras<br>
      ‚Ä¢ X% match = Confian√ßa na identifica√ß√£o do cliente
      </p>

      <hr style="margin:20px 0;border:none;border-top:1px solid #eee">

      <h3 style="color:#4361ee;margin-bottom:10px">‚öôÔ∏è CONFIGURA√á√ÉO</h3>
      <p><strong>Primeira vez usando?</strong></p>
      <ol style="margin-left:20px;font-size:12px">
        <li>Menu Planilha ‚Üí Extens√µes ‚Üí Apps Script</li>
        <li>Abra arquivo Code.gs</li>
        <li>Linha 15: Cole sua API Key do Claude</li>
        <li>Obtenha em: <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com/settings/keys</a></li>
        <li>Salve (Ctrl+S) e recarregue a planilha</li>
      </ol>

      <hr style="margin:20px 0;border:none;border-top:1px solid #eee">

      <h3 style="color:#4361ee;margin-bottom:10px">üìä RELAT√ìRIOS GERENCIAIS</h3>
      <p>Clique no bot√£o "üìä Relat√≥rios" no topo e escolha:</p>

      <p><strong>üë• Por Vendedor</strong></p>
      <p style="margin-left:20px;font-size:12px;color:#666">
      ‚Ä¢ Pipeline completo de cada vendedor<br>
      ‚Ä¢ Todas as propostas abertas com valores e status<br>
      ‚Ä¢ Propostas urgentes destacadas<br>
      ‚Ä¢ Estat√≠sticas: alta/m√©dia/baixa probabilidade
      </p>

      <p><strong>üó∫Ô∏è Por Estado</strong></p>
      <p style="margin-left:20px;font-size:12px;color:#666">
      ‚Ä¢ Distribui√ß√£o geogr√°fica das propostas<br>
      ‚Ä¢ Ranking de estados por valor<br>
      ‚Ä¢ Ticket m√©dio por regi√£o<br>
      ‚Ä¢ Concentra√ß√£o de neg√≥cios
      </p>

      <p><strong>üìà Relat√≥rio Executivo</strong></p>
      <p style="margin-left:20px;font-size:12px;color:#666">
      ‚Ä¢ Vis√£o completa do pipeline<br>
      ‚Ä¢ KPIs principais (convers√£o, urgentes, etc)<br>
      ‚Ä¢ Performance de cada vendedor<br>
      ‚Ä¢ Top 10 estados + an√°lise do funil
      </p>

      <p><strong>üìã Atividades do Pipeline</strong></p>
      <p style="margin-left:20px;font-size:12px;color:#666">
      ‚Ä¢ Hist√≥rico cronol√≥gico de todas as a√ß√µes<br>
      ‚Ä¢ Propostas criadas, mudan√ßas de etapa, contatos<br>
      ‚Ä¢ Vendas ganhas e perdidas por per√≠odo<br>
      ‚Ä¢ Filtro por data (calend√°rio) para an√°lise temporal
      </p>

      <p style="margin-top:15px;padding:12px;background:#e8f0fe;border-radius:6px;font-size:12px">
      <strong>üí° DICA PRO:</strong> Clique em "üìã Copiar" ap√≥s qualquer an√°lise de IA para salvar o texto e compartilhar com o vendedor via WhatsApp ou email!
      </p>
    </div>
  </div>
</div>

<!-- MODAL DASHBOARD -->
<div class="modal-bg" id="modalDashboard" onclick="if(event.target===this)fecharDashboard()">
  <div class="modal" style="max-width:1600px">
    <div class="modal-header">
      <h2>üìà Dashboard Analytics - Vis√£o Completa do Pipeline</h2>
      <button class="modal-close" onclick="fecharDashboard()">&times;</button>
    </div>
    <div class="modal-body" id="dashboardBody" style="padding:30px;max-height:85vh;overflow-y:auto">
      <div class="loading"><div class="loading-spinner"></div> Carregando dados do dashboard...</div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
console.log('üîÑ CRM PILI v2.0.1-20260126 - Registrar A√ß√£o oculto por padr√£o');

let propostas = [];
let vendedores = [];
let vendedorFiltro = null;
let etapas = {};
let propAtual = null;

document.addEventListener('DOMContentLoaded', carregar);

// FUN√á√ÉO DE ESCAPE PARA PREVENIR XSS
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
}

// FUN√á√ïES DE DEBUG
function debugLog(msg, tipo = 'info') {
  const el = document.getElementById('debugLog');
  if (!el) return;

  const cores = {
    info: '#4a9eff',
    success: '#27ae60',
    error: '#e74c3c',
    warn: '#f39c12'
  };

  const icones = {
    info: '‚ÑπÔ∏è',
    success: '‚úÖ',
    error: '‚ùå',
    warn: '‚ö†Ô∏è'
  };

  const timestamp = new Date().toLocaleTimeString();
  el.innerHTML += `<div style="margin:3px 0;padding:5px;background:rgba(255,255,255,0.05);border-left:3px solid ${cores[tipo]};border-radius:3px;">
    <span style="color:#888;font-size:9px;">[${timestamp}]</span> ${icones[tipo]} ${msg}
  </div>`;
  el.scrollTop = el.scrollHeight;
}

function toggleDebug() {
  const panel = document.getElementById('debugPanel');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    debugLog('Painel de debug aberto', 'info');
  } else {
    panel.style.display = 'none';
  }
}

function carregar() {
  console.log('Iniciando carregamento...');
  debugLog('üöÄ Iniciando carregamento do CRM...', 'info');

  // Limpar debug anterior
  const el = document.getElementById('debugLog');
  if (el) el.innerHTML = '';

  // Etapas
  debugLog('Carregando etapas...', 'info');
  google.script.run
    .withSuccessHandler(e => {
      etapas = e;
      console.log('Etapas carregadas:', e);
      debugLog('Etapas carregadas: ' + Object.keys(e).length + ' etapas', 'success');
    })
    .withFailureHandler(err => {
      console.error('Erro ao carregar etapas:', err);
      debugLog('ERRO ao carregar etapas: ' + err, 'error');
      alert('Erro ao carregar etapas: ' + err);
    })
    .getEtapas();

  // Resumo
  debugLog('Carregando resumo geral...', 'info');
  google.script.run
    .withSuccessHandler(r => {
      console.log('Resumo carregado:', r);
      if (!r || typeof r !== 'object') {
        debugLog('ERRO: Resumo inv√°lido recebido', 'error');
        return;
      }
      document.getElementById('rTotal').textContent = r.total || '0';
      document.getElementById('rValor').textContent = fmt(r.valor || 0);
      document.getElementById('rGanhos').textContent = r.ganhos || '0';
      document.getElementById('rTaxa').textContent = (r.taxa || 0) + '%';
      document.getElementById('rUrgentes').textContent = r.propostasUrgentes || '0';
      document.getElementById('rMediaDias').textContent = (r.mediaDiasFunil || 0) + 'd';
      debugLog('Resumo carregado: ' + (r.total || 0) + ' ativas, R$ ' + ((r.valor||0)/1000).toFixed(0) + 'k', 'success');
    })
    .withFailureHandler(err => {
      console.error('Erro ao carregar resumo:', err);
      debugLog('ERRO ao carregar resumo: ' + err, 'error');
    })
    .getResumoGeral();

  // Vendedores
  debugLog('Carregando vendedores...', 'info');
  console.log('üîç INICIANDO CHAMADA getDadosPorVendedor()');
  google.script.run
    .withSuccessHandler(v => {
      console.log('‚úÖ SUCCESS getDadosPorVendedor - Tipo:', typeof v, 'Valor:', v);
      console.log('Vendedores carregados:', v ? v.length : 0);
      if (v && v.length > 0) {
        console.log('Primeiro vendedor:', v[0]);
      }
      vendedores = v || [];
      console.log('üîç ANTES de renderVendedores() - vendedores.length:', vendedores.length);
      renderVendedores();
      console.log('‚úÖ DEPOIS de renderVendedores()');
      debugLog('Vendedores carregados: ' + vendedores.length + ' vendedores', 'success');
    })
    .withFailureHandler(err => {
      console.error('‚ùå FAILURE getDadosPorVendedor:', err);
      console.error('Tipo do erro:', typeof err);
      console.error('Stack:', err.stack || 'sem stack');
      vendedores = [];
      renderVendedores();
      debugLog('ERRO ao carregar vendedores: ' + err, 'error');
      alert('‚ùå ERRO ao carregar vendedores: ' + err);
    })
    .getDadosPorVendedor();

  // Propostas - MAIS IMPORTANTE
  debugLog('üéØ Carregando PROPOSTAS (mais importante)...', 'info');
  google.script.run
    .withSuccessHandler(p => {
      // DEBUG DETALHADO
      console.log('===== DEBUG FRONTEND - PROPOSTAS =====');
      console.log('Tipo de dado recebido:', typeof p);
      console.log('Valor recebido:', p);
      console.log('√â array?:', Array.isArray(p));
      console.log('√â null?:', p === null);
      console.log('√â undefined?:', p === undefined);
      console.log('Length (se array):', p ? p.length : 'N/A');
      if (p && p.length > 0) {
        console.log('Primeiras 3 propostas:', p.slice(0, 3));
        console.log('Tamanho JSON aproximado:', JSON.stringify(p).length + ' caracteres');
      }
      console.log('======================================');

      console.log('Propostas carregadas:', p ? p.length : 0);
      debugLog('‚úÖ Propostas recebidas: ' + (p ? p.length : 0), p && p.length > 0 ? 'success' : 'warn');

      if (!p || p.length === 0) {
        document.getElementById('propostasGrid').innerHTML = '<div class="loading">‚ùå Nenhuma proposta encontrada</div>';
        debugLog('‚ö†Ô∏è Nenhuma proposta retornada pelo backend', 'warn');
        return;
      }

      // N√ÉO FILTRAR - mostrar TODAS as propostas, o filtro ser√° aplicado depois
      propostas = p;
      console.log('Total propostas:', propostas.length);
      const ativas = propostas.filter(x => x.ativo);
      console.log('Propostas ativas:', ativas.length);

      debugLog('Total: ' + propostas.length + ' | Ativas: ' + ativas.length + ' | Ganhas: ' + propostas.filter(x => x.etapa === 'GANHO').length + ' | Perdidas: ' + propostas.filter(x => x.etapa === 'PERDIDO').length, 'success');
      debugLog('Aplicando filtros e renderizando...', 'info');

      aplicarFiltros();

      debugLog('‚úÖ CARREGAMENTO COMPLETO!', 'success');
    })
    .withFailureHandler(err => {
      console.error('===== ERRO CR√çTICO =====');
      console.error('Tipo do erro:', typeof err);
      console.error('Erro completo:', err);
      console.error('Mensagem:', err ? err.message : 'N/A');
      console.error('Stack:', err ? err.stack : 'N/A');
      console.error('========================');

      debugLog('‚ùå ERRO CR√çTICO: ' + JSON.stringify(err), 'error');
      document.getElementById('propostasGrid').innerHTML = '<div class="loading">‚ùå ERRO: ' + err + '<br><br>Verifique se a aba do formul√°rio existe e tem dados.</div>';
      alert('ERRO ao carregar propostas: ' + err + '\n\nVerifique:\n1. Se existe aba com "Respostas" no nome\n2. Se tem dados na planilha\n3. Clique no bot√£o DEBUG para mais detalhes');
    })
    .getPropostas();
}

function sincronizar() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Sincronizando...';

  google.script.run
    .withSuccessHandler(r => {
      alert(r.msg);
      carregar();
      btn.disabled = false;
      btn.textContent = 'üîÑ Sincronizar';
    })
    .withFailureHandler(e => {
      alert('Erro: ' + e);
      btn.disabled = false;
      btn.textContent = 'üîÑ Sincronizar';
    })
    .sincronizar();
}

function renderVendedores() {
  console.log('üé® renderVendedores() INICIADA');
  console.log('  vendedores:', vendedores);
  console.log('  vendedores.length:', vendedores ? vendedores.length : 'null/undefined');
  console.log('  propostas.length:', propostas ? propostas.length : 'null/undefined');

  const el = document.getElementById('listaVendedores');
  console.log('  elemento listaVendedores:', el ? 'ENCONTRADO' : 'N√ÉO ENCONTRADO');

  if (!el) {
    console.error('‚ùå Elemento listaVendedores N√ÉO ENCONTRADO no DOM!');
    return;
  }

  try {
    const totalAlertas = vendedores.reduce((s, v) => s + (v.alertasCriticos || 0), 0);
    console.log('  totalAlertas calculado:', totalAlertas);

    let html = `<div class="vend-item ${!vendedorFiltro ? 'ativo' : ''}" onclick="filtrarVendedor(null)">
      <div class="vend-nome">üìä Todos</div>
      <div class="vend-info">${propostas.length} propostas ${totalAlertas > 0 ? '<span class="vend-alertas">üö® ' + totalAlertas + ' alertas</span>' : ''}</div>
    </div>`;

    vendedores.forEach(v => {
      html += `<div class="vend-item ${vendedorFiltro === v.nome ? 'ativo' : ''}" onclick="filtrarVendedor('${escapeHtml(v.nome)}')">
        <div class="vend-nome">${escapeHtml(v.nome)}</div>
        <div class="vend-info">
          <span class="vend-valor">${fmt(v.valor || 0)}</span> | ${v.total || 0} ativas | ${v.taxa || 0}%
          ${(v.alertasCriticos || 0) > 0 ? '<br><span class="vend-alertas">üö® ' + v.alertasCriticos + ' alertas cr√≠ticos</span>' : ''}
        </div>
      </div>`;
    });

    console.log('  HTML gerado, tamanho:', html.length, 'caracteres');
    el.innerHTML = html;
    console.log('‚úÖ renderVendedores() CONCLU√çDA COM SUCESSO');
  } catch (e) {
    console.error('‚ùå ERRO em renderVendedores():', e);
    console.error('  Stack:', e.stack);
    el.innerHTML = '<div class="loading" style="color:red">‚ùå Erro: ' + e.message + '</div>';
  }
}

function filtrarVendedor(nome) {
  vendedorFiltro = nome;
  document.getElementById('areaTitle').textContent = nome ? nome : 'Todas as Propostas';
  renderVendedores();
  aplicarFiltros();
}

function aplicarFiltros() {
  debugLog('üìä aplicarFiltros() chamada - Total propostas: ' + propostas.length, 'info');
  let lista = [...propostas];

  if (vendedorFiltro) {
    lista = lista.filter(p => p.vendedor === vendedorFiltro);
    debugLog('Filtro vendedor "' + vendedorFiltro + '": ' + lista.length + ' propostas', 'info');
  }

  const etapaF = document.getElementById('filtroEtapa').value;
  if (etapaF) {
    // Se uma etapa espec√≠fica foi selecionada, filtrar por ela
    lista = lista.filter(p => p.etapa === etapaF);
    debugLog('Filtro etapa "' + etapaF + '": ' + lista.length + ' propostas', 'info');
  } else {
    // Se nenhuma etapa foi selecionada, mostrar TODAS as propostas (incluindo GANHO/PERDIDO)
    debugLog('Filtro padr√£o (todas as propostas): ' + lista.length + ' propostas', 'info');
  }

  const probF = document.getElementById('filtroProb').value;
  if (probF === 'alta') lista = lista.filter(p => p.prob >= 70);
  else if (probF === 'media') lista = lista.filter(p => p.prob >= 40 && p.prob < 70);
  else if (probF === 'baixa') lista = lista.filter(p => p.prob < 40);
  if (probF) debugLog('Filtro probabilidade "' + probF + '": ' + lista.length + ' propostas', 'info');

  const clienteF = document.getElementById('filtroCliente').value;
  if (clienteF === 'recorrente') lista = lista.filter(p => p.historicoCliente && p.historicoCliente.ganhas > 0);
  else if (clienteF === 'novo') lista = lista.filter(p => !p.historicoCliente || p.historicoCliente.ganhas === 0);
  else if (clienteF === 'fiel') lista = lista.filter(p => p.historicoCliente && p.historicoCliente.ganhas >= 3);
  if (clienteF) debugLog('Filtro cliente "' + clienteF + '": ' + lista.length + ' propostas', 'info');

  const alertaF = document.getElementById('filtroAlerta').value;
  if (alertaF === 'vencida') {
    // Pega tanto "VENCIDA" quanto "VENCE 3D", "VENCE 7D"
    lista = lista.filter(p => Array.isArray(p.alertas) && p.alertas.some(a => a.tipo === 'VENCIDA' || a.tipo.startsWith('VENCE ')));
  }
  else if (alertaF === 'semcontato') {
    // Pega "3D SEM CONTATO", "7D SEM CONTATO"
    lista = lista.filter(p => Array.isArray(p.alertas) && p.alertas.some(a => a.tipo.includes('SEM CONTATO')));
  }
  else if (alertaF === 'atrasada') {
    // Pega "A√á√ÉO ATRASADA"
    lista = lista.filter(p => Array.isArray(p.alertas) && p.alertas.some(a => a.tipo === 'A√á√ÉO ATRASADA'));
  }
  else if (alertaF === 'estagnada') {
    // Pega "PROPOSTA ESTAGNADA"
    lista = lista.filter(p => Array.isArray(p.alertas) && p.alertas.some(a => a.tipo === 'PROPOSTA ESTAGNADA'));
  }
  if (alertaF) debugLog('Filtro alerta "' + alertaF + '": ' + lista.length + ' propostas', 'info');

  const busca = document.getElementById('filtroBusca').value.toLowerCase();
  if (busca) {
    lista = lista.filter(p => {
      const cliente = String(p.cliente || '').toLowerCase();
      const num = String(p.num || '').toLowerCase();
      return cliente.includes(busca) || num.includes(busca);
    });
    debugLog('Busca "' + busca + '": ' + lista.length + ' propostas', 'info');
  }

  const ord = document.getElementById('ordenacao').value;
  if (ord === 'prob') lista.sort((a, b) => b.prob - a.prob);
  else if (ord === 'valor') lista.sort((a, b) => b.valor - a.valor);
  else if (ord === 'vencer') lista.sort((a, b) => a.diasVencer - b.diasVencer);
  else if (ord === 'contato') lista.sort((a, b) => b.diasContato - a.diasContato);
  else if (ord === 'recente') lista.sort((a, b) => a.diasProposta - b.diasProposta);

  debugLog('üé® Renderizando ' + lista.length + ' propostas...', 'info');
  renderPropostas(lista);
}

function renderPropostas(lista) {
  const el = document.getElementById('propostasGrid');
  debugLog('renderPropostas() - Renderizando ' + lista.length + ' propostas', 'info');

  if (!lista.length) {
    el.innerHTML = '<div class="loading">‚ùå Nenhuma proposta encontrada</div>';
    debugLog('Lista vazia - exibindo mensagem de "nenhuma proposta"', 'warn');
    return;
  }

  debugLog('Gerando HTML para ' + lista.length + ' cards...', 'info');

  el.innerHTML = lista.map(p => {
    const alertasHtml = Array.isArray(p.alertas) ? p.alertas.map(a => `<span class="alerta alerta-${a.cor}">${escapeHtml(a.tipo || '')}</span>`).join('') : '';
    const temAlertaCritico = Array.isArray(p.alertas) && p.alertas.some(a => a.cor === 'red');
    const altaProb = p.prob >= 70;
    const recorrente = p.historicoCliente && p.historicoCliente.ganhas > 0;
    const fiel = p.historicoCliente && p.historicoCliente.ganhas >= 3;
    const matchScore = p.scoreMatch ? Math.round(p.scoreMatch * 100) : 0;

    let clienteBadges = '';
    if (fiel) {
      clienteBadges += '<span class="badge-cliente-fiel">‚≠ê FIEL</span>';
    } else if (recorrente) {
      clienteBadges += '<span class="badge-recorrente">üîÅ RECORRENTE</span>';
    }
    if (matchScore > 0) {
      clienteBadges += `<span class="badge-match">${matchScore}% match</span>`;
    }

    return `<div class="card ${temAlertaCritico ? 'urgente' : ''} ${altaProb ? 'alta-prob' : ''}" onclick="abrirProposta('${escapeHtml(String(p.num))}')" style="cursor:pointer">
      <div class="card-header">
        <span class="card-num">#${escapeHtml(p.num)} | ${p.diasProposta || 0}d no funil</span>
        <span class="card-prob" style="background:${p.probCor || '#ccc'}20;color:${p.probCor || '#999'}">${p.prob || 0}% ${escapeHtml(p.probLabel || '')}</span>
      </div>
      <div class="card-cliente">
        ${escapeHtml(p.cliente)}
      </div>
      ${clienteBadges ? `<div style="margin-bottom:8px">${clienteBadges}</div>` : ''}
      <div style="font-size:13px;color:#1a1a2e;margin-bottom:4px;font-weight:600;line-height:1.3">
        üì¶ ${escapeHtml(p.produto || 'Produto n√£o especificado')}
      </div>
      ${(p.produtoTamanho || p.produtoModelo || p.produtoCapacidade || p.produtoTrilhos) ? `
        <div style="font-size:11px;color:#666;margin-bottom:8px;line-height:1.4;padding-left:20px">
          ${p.produtoTamanho ? `‚Ä¢ Tamanho: ${escapeHtml(p.produtoTamanho)}<br>` : ''}
          ${p.produtoModelo ? `‚Ä¢ Modelo: ${escapeHtml(p.produtoModelo)}<br>` : ''}
          ${p.produtoCapacidade ? `‚Ä¢ Capacidade: ${escapeHtml(p.produtoCapacidade)}<br>` : ''}
          ${p.produtoTrilhos ? `‚Ä¢ Trilhos: ${escapeHtml(p.produtoTrilhos)}m<br>` : ''}
          ${p.produtoAcionamento ? `‚Ä¢ Acionamento: ${escapeHtml(p.produtoAcionamento)}` : ''}
        </div>
      ` : ''}
      <div class="card-valor">${escapeHtml(p.valorFmtCompleto || 'R$ 0,00')}</div>
      <span class="card-etapa" style="background:${p.etapaInfo?.cor || '#ccc'}">${escapeHtml(p.etapaInfo?.label || 'N/A')}</span>
      <div class="card-info">
        <span>üìÖ Validade: ${escapeHtml(p.validade || '-')}</span>
        <span>üìû Contato: ${escapeHtml(p.ultContato || 'Nunca')}</span>
      </div>
      ${alertasHtml ? `<div class="card-alertas">${alertasHtml}</div>` : ''}
      <div class="card-footer">
        <span class="card-vendedor">üë§ ${escapeHtml(p.vendedor)}</span>
        ${p.proxPasso ? `<span class="card-contato">‚è≠Ô∏è ${escapeHtml(p.proxPasso)}</span>` : ''}
      </div>
    </div>`;
  }).join('');

  debugLog('‚úÖ HTML inserido no DOM - ' + lista.length + ' cards renderizados', 'success');
}

function abrirProposta(num) {
  console.log('abrirProposta chamada:', num, typeof num);
  console.log('Total propostas dispon√≠veis:', propostas.length);

  // Converter para string para compara√ß√£o segura
  const numStr = String(num);
  propAtual = propostas.find(p => String(p.num) === numStr);

  if (!propAtual) {
    console.error('Proposta n√£o encontrada:', numStr);
    console.log('N√∫meros dispon√≠veis:', propostas.map(p => String(p.num)).slice(0, 10));
    alert('Erro: Proposta #' + numStr + ' n√£o encontrada');
    return;
  }

  console.log('Proposta encontrada:', propAtual);

  const p = propAtual;
  document.getElementById('modalTitulo').textContent = '#' + p.num + ' - ' + p.cliente;

  const etapasBtns = Object.entries(etapas)
    .filter(([k, v]) => v.ordem < 10)
    .sort((a, b) => a[1].ordem - b[1].ordem)
    .map(([k, v]) => `<button class="etapa-btn ${p.etapa === k ? 'atual' : ''}" onclick="mudarEtapa('${escapeHtml(p.num)}', '${escapeHtml(k)}')" style="border-color:${p.etapa === k ? v.cor : '#ddd'}">${v.label}</button>`)
    .join('');

  const alertasHtml = Array.isArray(p.alertas) ? p.alertas.map(a => `<span class="alerta alerta-${a.cor}">${escapeHtml(a.tipo || '')}</span>`).join(' ') : '';

  const fatoresHtml = p.probFatores && p.probFatores.length > 0
    ? p.probFatores.map(f => `<div class="fator-item">
        <span>${escapeHtml(f.fator || '')}: ${escapeHtml(f.detalhe || '')}</span>
        <span class="fator-impacto ${(f.impacto || '').startsWith('+') ? 'positivo' : 'negativo'}">${escapeHtml(f.impacto || '')}</span>
      </div>`).join('')
    : '<div class="fator-item">Sem fatores calculados</div>';

  const clienteRecorrente = p.historicoCliente && p.historicoCliente.ganhas > 0;
  const matchScore = p.scoreMatch ? Math.round(p.scoreMatch * 100) : 0;

  const clienteInfoHtml = clienteRecorrente ? `
    <div class="cliente-info">
      <h4>
        ${p.historicoCliente.ganhas >= 3 ? '‚≠ê CLIENTE FIEL' : 'üîÅ CLIENTE RECORRENTE'}
        ${matchScore > 0 ? `<span class="match-score">üìä ${matchScore}% match</span>` : ''}
      </h4>
      <p><strong>Padr√£o:</strong> ${escapeHtml(p.historicoCliente.padraoCompra || 'N/A')}</p>
      <p><strong>√öltima compra:</strong> ${escapeHtml(p.historicoCliente.ultimaCompra || 'N/A')}</p>
      <p><strong>Produtos j√° comprados:</strong> ${escapeHtml(p.historicoCliente.produtos || 'N/A')}</p>

      <div class="stats">
        <div class="stat-box">
          <div class="stat-num">${p.historicoCliente.ganhas}</div>
          <div class="stat-label">Compras</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">R$ ${(p.historicoCliente.valorTotal || 0).toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
          <div class="stat-label">Valor Total</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">${p.historicoCliente.taxaConversao || 0}%</div>
          <div class="stat-label">Convers√£o</div>
        </div>
      </div>

      ${p.historicoCliente.ticketMedio && p.historicoCliente.ticketMedio > 0 ? `<p style="margin-top:8px"><strong>Ticket M√©dio:</strong> R$ ${p.historicoCliente.ticketMedio.toLocaleString('pt-BR')}</p>` : ''}
      ${p.historicoCliente.tempoMedioFechamento && p.historicoCliente.tempoMedioFechamento > 0 ? `<p><strong>Tempo m√©dio fechamento:</strong> ${p.historicoCliente.tempoMedioFechamento} dias</p>` : ''}
      ${p.historicoCliente.sazonalidade ? `<p><strong>Sazonalidade:</strong> Compra mais em ${escapeHtml(p.historicoCliente.sazonalidade)}</p>` : ''}
    </div>
  ` : '';

  document.getElementById('modalBody').innerHTML = `
    ${clienteInfoHtml}

    <div class="prop-resumo">
      <div class="prop-box">
        <div class="prop-box-label">üí∞ Valor</div>
        <div class="prop-box-value grande">${p.valorFmtCompleto || p.valorFmt}</div>
      </div>
      <div class="prop-box">
        <div class="prop-box-label">üìà Probabilidade</div>
        <div class="prop-box-value grande" style="color:${p.probCor}">${p.prob}%</div>
      </div>
      <div class="prop-box">
        <div class="prop-box-label">üìù Criada em</div>
        <div class="prop-box-value">${p.dataCriacao} <small>(${p.diasProposta}d no funil)</small></div>
      </div>
      <div class="prop-box">
        <div class="prop-box-label">üìÖ Validade</div>
        <div class="prop-box-value">${p.validade} <small>(${p.diasVencer <= 0 ? 'üö® VENCIDA' : p.diasVencer + 'd'})</small></div>
      </div>
      <div class="prop-box">
        <div class="prop-box-label">üìû √öltimo Contato</div>
        <div class="prop-box-value">${p.ultContato} <small>(${p.diasContato}d atr√°s)</small></div>
      </div>
    </div>

    ${alertasHtml ? `<div style="margin-bottom:16px">${alertasHtml}</div>` : ''}

    ${p.produto ? `
    <div class="secao" style="margin-bottom:20px">
      <div class="secao-titulo">üì¶ Detalhes do Produto</div>
      <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-top:10px">
        <div style="font-size:15px;font-weight:600;color:#1a1a2e;margin-bottom:10px">${escapeHtml(p.produto)}</div>
        ${p.produtoTamanho || p.produtoModelo || p.produtoCapacidade || p.produtoTrilhos || p.produtoAcionamento ? `
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:13px;color:#555">
            ${p.produtoTamanho ? `<div><strong>Tamanho:</strong> ${escapeHtml(p.produtoTamanho)}</div>` : ''}
            ${p.produtoModelo ? `<div><strong>Modelo:</strong> ${escapeHtml(p.produtoModelo)}</div>` : ''}
            ${p.produtoCapacidade ? `<div><strong>Capacidade:</strong> ${escapeHtml(p.produtoCapacidade)}</div>` : ''}
            ${p.produtoTrilhos ? `<div><strong>Comprimento Trilhos:</strong> ${escapeHtml(p.produtoTrilhos)}m</div>` : ''}
            ${p.produtoAcionamento ? `<div><strong>Acionamento:</strong> ${escapeHtml(p.produtoAcionamento)}</div>` : ''}
          </div>
        ` : '<div style="font-size:12px;color:#888">Sem especifica√ß√µes t√©cnicas dispon√≠veis</div>'}
      </div>
    </div>
    ` : ''}

    <div class="fatores-prob">
      <h4>üìä Fatores da Probabilidade (${p.prob}%)</h4>
      ${fatoresHtml}
    </div>

    <div class="secao">
      <div class="secao-titulo">ü§ñ An√°lise IA - Subs√≠dios para Gest√£o <span class="badge-ia">Claude</span></div>

      <!-- An√°lise & Subs√≠dios -->
      <div class="ia-box" style="margin-bottom:12px">
        <div style="font-weight:600;font-size:12px;margin-bottom:8px;color:#0369a1">üîç An√°lise & Subs√≠dios</div>
        <div class="ia-box-content" id="iaAnalise">${p.analiseIA || 'üí° Clique para receber subs√≠dios detalhados: como cobrar o vendedor, ferramentas prontas e estrat√©gia de fechamento.'}</div>
        <div class="ia-box-actions">
          <button class="btn btn-primary" onclick="analisarComIA('${escapeHtml(p.num)}')" data-tooltip="Cobran√ßa pro vendedor + scripts + argumentos + cronograma">üîç Analisar & Gerar Subs√≠dios</button>
          <button class="btn btn-ghost" style="background:#f0f0f0;color:#333" onclick="copiarConteudo('iaAnalise')" data-tooltip="Copiar an√°lise pro clipboard">üìã Copiar</button>
        </div>
      </div>

      <!-- Dados do Cliente -->
      <div class="ia-box" style="margin-bottom:12px">
        <div style="font-weight:600;font-size:12px;margin-bottom:8px;color:#0369a1">üè¢ Dados do Cliente</div>
        <div class="ia-box-content" id="iaDadosCliente">üí° Clique para buscar dados da empresa (CNPJ, porte, setor, capacidade de armazenagem).</div>
        <div class="ia-box-actions">
          <button class="btn btn-primary" onclick="buscarDadosCliente('${escapeHtml(p.num)}')" data-tooltip="Busca CNPJ + porte + setor + capacidade armazenagem">üè¢ Buscar Dados do Cliente</button>
          <button class="btn btn-ghost" style="background:#f0f0f0;color:#333" onclick="copiarConteudo('iaDadosCliente')" data-tooltip="Copiar dados pro clipboard">üìã Copiar</button>
        </div>
      </div>

      <!-- Mensagem WhatsApp -->
      <div class="ia-box">
        <div style="font-weight:600;font-size:12px;margin-bottom:8px;color:#0369a1">üí¨ Mensagem WhatsApp</div>
        <div class="ia-box-content" id="iaMensagem">üí° Clique para gerar mensagem WhatsApp pronta para o vendedor enviar ao cliente.</div>
        <div class="ia-box-actions">
          <button class="btn btn-primary" onclick="sugerirMensagem('${escapeHtml(p.num)}')" data-tooltip="WhatsApp pronto pra copiar e enviar">üí¨ Gerar Mensagem p/ Vendedor</button>
          <button class="btn btn-ghost" style="background:#f0f0f0;color:#333" onclick="copiarConteudo('iaMensagem')" data-tooltip="Copiar mensagem pro clipboard">üìã Copiar</button>
        </div>
      </div>
    </div>

    <div class="secao">
      <div class="secao-titulo">üí° Equipar Vendedor - Resposta para Obje√ß√£o</div>
      <div class="campo">
        <label>Qual foi a obje√ß√£o do cliente ao vendedor ${escapeHtml(p.vendedor)}?</label>
        <input type="text" id="inputObjecao" placeholder="Ex: Est√° muito caro, vou ver com concorrente...">
      </div>
      <button class="btn btn-primary" style="width:auto" onclick="responderObjecao('${escapeHtml(p.num)}')">üéØ Gerar Script & Argumentos</button>
    </div>

    <div class="secao">
      <div class="secao-titulo">üéØ Etapa do Funil</div>
      <div class="etapas-btns">${etapasBtns}</div>
    </div>

    <div class="secao" id="secaoRegistrarAcao" style="display:none">
      <div class="secao-titulo">üìù Registrar A√ß√£o</div>
      <div class="campo">
        <label>O que foi feito?</label>
        <textarea id="inputAcao" placeholder="Ex: Liguei, cliente pediu mais prazo..."></textarea>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="campo">
          <label>Pr√≥ximo passo</label>
          <input type="text" id="inputProx" value="${escapeHtml(p.proxPasso || '')}" placeholder="Ex: Ligar novamente">
        </div>
        <div class="campo">
          <label>Data</label>
          <input type="date" id="inputDataProx">
        </div>
      </div>
      <button class="btn-salvar" onclick="salvarAcao('${escapeHtml(p.num)}')">‚úÖ Registrar A√ß√£o</button>
    </div>

    <div class="secao">
      <div class="secao-titulo">üìú Hist√≥rico</div>
      <div class="historico">${escapeHtml(p.hist || 'Nenhuma intera√ß√£o registrada')}</div>
    </div>

    <div class="secao">
      <div class="secao-titulo">üèÅ Finalizar</div>
      <div style="display:flex;gap:12px">
        <button class="btn-finalizar btn-ganho" onclick="finalizar('${escapeHtml(p.num)}', 'GANHO')">‚úÖ Marcar como GANHO</button>
        <button class="btn-finalizar btn-perdido" onclick="finalizar('${escapeHtml(p.num)}', 'PERDIDO')">‚ùå Marcar como PERDIDO</button>
      </div>
    </div>

    <div class="secao" style="margin-top:20px;padding-top:16px;border-top:1px solid #eee">
      <div style="margin-bottom:14px;padding:12px;background:#f8f9fa;border-radius:8px;border-left:4px solid #4361ee">
        <div style="font-size:11px;color:#666;text-transform:uppercase;margin-bottom:4px;font-weight:600">üì¶ Produto</div>
        <div style="font-size:14px;color:#1a1a2e;font-weight:600">${p.produto || 'Produto n√£o especificado'}</div>
      </div>
      <div style="font-size:11px;color:#888">
        <strong>üìû Contato:</strong> ${p.telefone || '-'} | ${p.email || '-'}<br>
        <strong>üë§ Vendedor:</strong> ${p.vendedor} | <strong>üìç Local:</strong> ${p.estado}<br>
        <strong>üìÖ Cria√ß√£o:</strong> ${p.dataCriacao} | <strong>#Proposta:</strong> ${p.num}
      </div>
    </div>
  `;

  document.getElementById('modalProposta').classList.add('aberto');
}

function fecharModal() {
  document.getElementById('modalProposta').classList.remove('aberto');
  propAtual = null;
}

function mostrarAjuda() {
  document.getElementById('modalAjuda').classList.add('aberto');
}

function fecharAjuda() {
  document.getElementById('modalAjuda').classList.remove('aberto');
}

function mostrarRelatorios() {
  // Popular dropdowns de vendedor e estado
  popularFiltrosRelatorio();
  document.getElementById('modalRelatorios').classList.add('aberto');
}

function popularFiltrosRelatorio() {
  // Popular dropdown de vendedores
  const vendedoresUnicos = [...new Set(propostas.map(p => p.vendedor))].sort();
  const selectVendedor = document.getElementById('filtroVendedorRelatorio');
  selectVendedor.innerHTML = '<option value="">Todos os vendedores</option>';
  vendedoresUnicos.forEach(v => {
    const option = document.createElement('option');
    option.value = v;
    option.textContent = v;
    selectVendedor.appendChild(option);
  });

  // Popular dropdown de estados
  const estadosUnicos = [...new Set(propostas.map(p => p.estado).filter(e => e))].sort();
  const selectEstado = document.getElementById('filtroEstadoRelatorio');
  selectEstado.innerHTML = '<option value="">Todos os estados</option>';
  estadosUnicos.forEach(e => {
    const option = document.createElement('option');
    option.value = e;
    option.textContent = e;
    selectEstado.appendChild(option);
  });
}

function fecharRelatorios() {
  document.getElementById('modalRelatorios').classList.remove('aberto');
}

function gerarRelatorioVendedor() {
  const btn = document.getElementById('btnRelatorioVendedor');
  const filtros = obterFiltrosRelatorio();

  // Desabilitar bot√£o e mostrar loading
  btn.disabled = true;
  btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">‚è≥ Gerando...</div><div style="font-size:13px;color:#666">Aguarde enquanto processamos os dados...</div>';

  google.script.run
    .withSuccessHandler(() => {
      btn.disabled = false;
      btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">üë• Por Vendedor</div><div style="font-size:13px;color:#666">Pipeline de cada vendedor com propostas, valores e status</div>';
      fecharRelatorios();
    })
    .withFailureHandler((err) => {
      btn.disabled = false;
      btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">üë• Por Vendedor</div><div style="font-size:13px;color:#666">Pipeline de cada vendedor com propostas, valores e status</div>';
      alert('‚ùå Erro ao gerar relat√≥rio: ' + err);
    })
    .gerarRelatorioPorVendedor(filtros.dataInicio, filtros.dataFim, filtros.status, filtros.vendedor, filtros.estado);
}

function gerarRelatorioEstado() {
  const btn = document.getElementById('btnRelatorioEstado');
  const filtros = obterFiltrosRelatorio();

  // Desabilitar bot√£o e mostrar loading
  btn.disabled = true;
  btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">‚è≥ Gerando...</div><div style="font-size:13px;color:#666">Aguarde enquanto processamos os dados...</div>';

  google.script.run
    .withSuccessHandler(() => {
      btn.disabled = false;
      btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">üó∫Ô∏è Por Estado</div><div style="font-size:13px;color:#666">Distribui√ß√£o geogr√°fica das propostas e valores por regi√£o</div>';
      fecharRelatorios();
    })
    .withFailureHandler((err) => {
      btn.disabled = false;
      btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">üó∫Ô∏è Por Estado</div><div style="font-size:13px;color:#666">Distribui√ß√£o geogr√°fica das propostas e valores por regi√£o</div>';
      alert('‚ùå Erro ao gerar relat√≥rio: ' + err);
    })
    .gerarRelatorioPorEstado(filtros.dataInicio, filtros.dataFim, filtros.status, filtros.vendedor, filtros.estado);
}

function gerarRelatorioCompleto() {
  const btn = document.getElementById('btnRelatorioCompleto');
  const filtros = obterFiltrosRelatorio();

  // Desabilitar bot√£o e mostrar loading
  btn.disabled = true;
  btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">‚è≥ Gerando...</div><div style="font-size:13px;color:#666">Aguarde, este relat√≥rio pode levar alguns segundos...</div>';

  google.script.run
    .withSuccessHandler(() => {
      btn.disabled = false;
      btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">üìà Relat√≥rio Executivo</div><div style="font-size:13px;color:#666">Vis√£o completa: resumo + vendedores + estados + performance</div>';
      fecharRelatorios();
    })
    .withFailureHandler((err) => {
      btn.disabled = false;
      btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">üìà Relat√≥rio Executivo</div><div style="font-size:13px;color:#666">Vis√£o completa: resumo + vendedores + estados + performance</div>';
      alert('‚ùå Erro ao gerar relat√≥rio: ' + err);
    })
    .gerarRelatorioExecutivoCompleto(filtros.dataInicio, filtros.dataFim, filtros.status, filtros.vendedor, filtros.estado);
}

function gerarRelatorioAtividades() {
  const btn = document.getElementById('btnRelatorioAtividades');
  const filtros = obterFiltrosRelatorio();

  // Desabilitar bot√£o e mostrar loading
  btn.disabled = true;
  btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">‚è≥ Gerando...</div><div style="font-size:13px;color:#666">Processando hist√≥rico de atividades...</div>';

  google.script.run
    .withSuccessHandler(() => {
      btn.disabled = false;
      btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">üìã Atividades do Pipeline</div><div style="font-size:13px;color:#666">Hist√≥rico de a√ß√µes, mudan√ßas de etapa e intera√ß√µes por per√≠odo</div>';
      fecharRelatorios();
    })
    .withFailureHandler((err) => {
      btn.disabled = false;
      btn.innerHTML = '<div style="font-size:20px;margin-bottom:8px">üìã Atividades do Pipeline</div><div style="font-size:13px;color:#666">Hist√≥rico de a√ß√µes, mudan√ßas de etapa e intera√ß√µes por per√≠odo</div>';
      alert('‚ùå Erro ao gerar relat√≥rio: ' + err);
    })
    .gerarRelatorioAtividades(filtros.dataInicio, filtros.dataFim, filtros.status, filtros.vendedor, filtros.estado);
}

function obterFiltrosRelatorio() {
  const dataInicio = document.getElementById('dataInicioRelatorio').value || null;
  const dataFim = document.getElementById('dataFimRelatorio').value || null;
  const incluirAbertos = document.getElementById('incluirAbertos').checked;
  const incluirGanhos = document.getElementById('incluirGanhos').checked;
  const incluirPerdidos = document.getElementById('incluirPerdidos').checked;
  const vendedor = document.getElementById('filtroVendedorRelatorio').value || null;
  const estado = document.getElementById('filtroEstadoRelatorio').value || null;

  const status = [];
  if (incluirAbertos) status.push('ABERTAS');
  if (incluirGanhos) status.push('GANHO');
  if (incluirPerdidos) status.push('PERDIDO');

  return { dataInicio, dataFim, status, vendedor, estado };
}

function gerarRelatorioComFiltrosModal() {
  // Obter filtros do modal de relat√≥rios
  const filtros = obterFiltrosRelatorio();

  // Verificar se h√° propostas carregadas
  if (!propostas || propostas.length === 0) {
    alert('‚ö†Ô∏è Nenhuma proposta carregada!\n\nCarregue as propostas primeiro.');
    return;
  }

  // Verificar se algum filtro foi aplicado
  const temFiltros = filtros.dataInicio || filtros.dataFim || filtros.status.length > 0 || filtros.vendedor || filtros.estado;

  if (!temFiltros) {
    alert('‚ö†Ô∏è Nenhum filtro aplicado!\n\nSelecione pelo menos um filtro (per√≠odo, status, vendedor ou estado) antes de gerar o relat√≥rio.');
    return;
  }

  // Filtrar propostas com base nos filtros do modal
  let lista = [...propostas];

  // Filtro de per√≠odo (data de cria√ß√£o)
  if (filtros.dataInicio) {
    const dataInicio = new Date(filtros.dataInicio);
    lista = lista.filter(p => {
      if (!p.dataCriacao) return false;
      const dataProp = new Date(p.dataCriacao);
      return dataProp >= dataInicio;
    });
  }

  if (filtros.dataFim) {
    const dataFim = new Date(filtros.dataFim);
    dataFim.setHours(23, 59, 59, 999); // Incluir o dia inteiro
    lista = lista.filter(p => {
      if (!p.dataCriacao) return false;
      const dataProp = new Date(p.dataCriacao);
      return dataProp <= dataFim;
    });
  }

  // Filtro de status
  if (filtros.status.length > 0) {
    lista = lista.filter(p => {
      if (filtros.status.includes('ABERTAS') && p.etapa !== 'GANHO' && p.etapa !== 'PERDIDO') return true;
      if (filtros.status.includes('GANHO') && p.etapa === 'GANHO') return true;
      if (filtros.status.includes('PERDIDO') && p.etapa === 'PERDIDO') return true;
      return false;
    });
  }

  // Filtro de vendedor
  if (filtros.vendedor) {
    lista = lista.filter(p => p.vendedor === filtros.vendedor);
  }

  // Filtro de estado
  if (filtros.estado) {
    lista = lista.filter(p => p.estado === filtros.estado);
  }

  // Verificar se h√° resultados
  if (lista.length === 0) {
    alert('‚ö†Ô∏è Nenhuma proposta encontrada com os filtros aplicados!\n\nTente ajustar os filtros.');
    return;
  }

  // Criar descri√ß√£o dos filtros
  const descricaoFiltros = [];
  if (filtros.dataInicio && filtros.dataFim) {
    descricaoFiltros.push('Per√≠odo: ' + filtros.dataInicio + ' a ' + filtros.dataFim);
  } else if (filtros.dataInicio) {
    descricaoFiltros.push('De: ' + filtros.dataInicio);
  } else if (filtros.dataFim) {
    descricaoFiltros.push('At√©: ' + filtros.dataFim);
  }

  if (filtros.status.length > 0) {
    descricaoFiltros.push('Status: ' + filtros.status.join(', '));
  }

  if (filtros.vendedor) {
    descricaoFiltros.push('Vendedor: ' + filtros.vendedor);
  }

  if (filtros.estado) {
    descricaoFiltros.push('Estado: ' + filtros.estado);
  }

  // Calcular totais
  const valorTotal = lista.reduce((s, p) => s + (p.valor || 0), 0);

  const confirmacao = confirm(
    'üìä Gerar relat√≥rio com os seguintes filtros?\n\n' +
    descricaoFiltros.join('\n') +
    '\n\nTotal de propostas: ' + lista.length +
    '\nValor total: ' + fmt(valorTotal) +
    '\n\nO relat√≥rio ser√° gerado em uma nova janela.'
  );

  if (!confirmacao) return;

  // Mostrar mensagem de processamento
  alert('‚è≥ Gerando relat√≥rio...\n\nAguarde enquanto processamos os dados.');

  // Chamar backend para gerar relat√≥rio Excel com a lista filtrada
  google.script.run
    .withSuccessHandler(() => {
      console.log('Relat√≥rio filtrado gerado com sucesso');
      fecharRelatorios();
    })
    .withFailureHandler(err => {
      alert('‚ùå Erro ao gerar relat√≥rio: ' + err);
    })
    .gerarRelatorioComFiltrosAplicados(lista, descricaoFiltros.join(' | '));
}

function mudarEtapa(num, etapa) {
  const nomeEtapa = etapas[etapa].label;

  if (!confirm('Confirma mover para ' + nomeEtapa + '?')) return;

  google.script.run.withSuccessHandler(() => {
    // MOSTRAR a se√ß√£o de registro que estava oculta
    const secaoRegistro = document.getElementById('secaoRegistrarAcao');
    if (secaoRegistro) {
      secaoRegistro.style.display = 'block';
    }

    // N√ÉO FECHAR O MODAL - mostrar campo de registro
    alert('‚úÖ Etapa atualizada para: ' + nomeEtapa + '\n\nAgora registre o que foi feito para chegar nesta etapa.');

    // Preencher campo de a√ß√£o com sugest√£o
    const campoAcao = document.getElementById('inputAcao');
    if (campoAcao) {
      campoAcao.value = 'Movido para: ' + nomeEtapa + '\n\n';
      campoAcao.focus();
      campoAcao.setSelectionRange(campoAcao.value.length, campoAcao.value.length);
    }

    // Rolar at√© a se√ß√£o de registro
    if (secaoRegistro) {
      secaoRegistro.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else if (campoAcao) {
      campoAcao.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Recarregar dados em background
    carregar();
  }).mudarEtapa(num, etapa);
}

function salvarAcao(num) {
  const acao = document.getElementById('inputAcao').value;
  const prox = document.getElementById('inputProx').value;
  const data = document.getElementById('inputDataProx').value;

  if (!acao) { alert('‚ö†Ô∏è Descreva a a√ß√£o realizada'); return; }

  google.script.run.withSuccessHandler(() => {
    alert('‚úÖ A√ß√£o registrada!');
    fecharModal();
    carregar();
  }).registrarAcao(num, acao, '', prox, data);
}

function analisarComIA(num) {
  const el = document.getElementById('iaAnalise');
  el.innerHTML = '<div class="loading-spinner"></div> ü§ñ Analisando com IA...';

  google.script.run.withSuccessHandler(r => {
    if (r.erro) el.textContent = '‚ùå Erro: ' + r.erro;
    else el.textContent = r.analise;
  }).withFailureHandler(e => {
    el.textContent = '‚ùå Erro: ' + e;
  }).iaAnalisarProposta(num);
}

function buscarDadosCliente(num) {
  const el = document.getElementById('iaDadosCliente');
  el.innerHTML = '<div class="loading-spinner"></div> üîç Buscando dados do cliente...';

  google.script.run.withSuccessHandler(r => {
    if (r.erro) el.textContent = '‚ùå Erro: ' + r.erro;
    else {
      let texto = '';
      if (r.dadosCNPJ && !r.dadosCNPJ.necessitaBuscaManual) {
        texto += '=== üè¢ DADOS DO CNPJ ===\n';
        texto += 'üìÑ Raz√£o Social: ' + (r.dadosCNPJ.razaoSocial || '-') + '\n';
        texto += 'üè™ Fantasia: ' + (r.dadosCNPJ.fantasia || '-') + '\n';
        texto += '‚úÖ Situa√ß√£o: ' + (r.dadosCNPJ.situacao || '-') + '\n';
        texto += 'üìä Porte: ' + (r.dadosCNPJ.porte || '-') + '\n';
        texto += 'üí∞ Capital Social: R$ ' + (r.dadosCNPJ.capitalSocial || '-') + '\n';
        texto += 'üè≠ Atividade: ' + (r.dadosCNPJ.atividadePrincipal || '-') + '\n';
        texto += 'üìç Endere√ßo: ' + (r.dadosCNPJ.endereco || '-') + '\n\n';
      }
      texto += r.analise;
      el.textContent = texto;
    }
  }).withFailureHandler(e => {
    el.textContent = '‚ùå Erro: ' + e;
  }).buscarDadosClienteIA(num);
}

function sugerirMensagem(num) {
  const el = document.getElementById('iaMensagem');
  el.innerHTML = '<div class="loading-spinner"></div> üí¨ Gerando mensagem...';

  google.script.run.withSuccessHandler(msg => {
    el.textContent = 'üì± MENSAGEM WHATSAPP PRONTA:\n\n' + msg + '\n\nüí° Copie e cole no WhatsApp!';
  }).withFailureHandler(e => {
    el.textContent = '‚ùå Erro: ' + e;
  }).iaSugerirMensagem(num, 'follow-up');
}

function responderObjecao(num) {
  const objecao = document.getElementById('inputObjecao').value;
  if (!objecao) { alert('‚ö†Ô∏è Digite a obje√ß√£o do cliente'); return; }

  const el = document.getElementById('iaAnalise');
  el.innerHTML = '<div class="loading-spinner"></div> üéØ Gerando resposta...';

  google.script.run.withSuccessHandler(r => {
    el.textContent = r;
  }).withFailureHandler(e => {
    el.textContent = '‚ùå Erro: ' + e;
  }).iaResponderObjecao(objecao, num);
}

function copiarConteudo(elementId) {
  const texto = document.getElementById(elementId).textContent;
  navigator.clipboard.writeText(texto).then(() => alert('‚úÖ Copiado!'));
}

function finalizar(num, tipo) {
  const msg = tipo === 'GANHO' ? 'üéâ Confirma GANHO desta proposta?' : 'üòî Confirma PERDA desta proposta?';
  if (!confirm(msg)) return;

  google.script.run.withSuccessHandler(() => {
    alert(tipo === 'GANHO' ? 'üéâ Parab√©ns pelo fechamento!' : 'üìù Proposta marcada como perdida');
    fecharModal();
    carregar();
  }).mudarEtapa(num, tipo);
}

function fmt(v) {
  if (!v) return 'R$ 0';
  return 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0});
}

function testarComunicacao() {
  debugLog('üß™ Iniciando TESTE de comunica√ß√£o...', 'info');
  console.log('üß™ Chamando getPropostasTeste()...');

  google.script.run
    .withSuccessHandler(dados => {
      console.log('üß™ TESTE SUCESSO!', dados);
      debugLog('‚úÖ TESTE BEM-SUCEDIDO! Recebidas ' + (dados ? dados.length : 0) + ' propostas', 'success');
      alert('‚úÖ COMUNICA√á√ÉO OK!\n\nRecebidas ' + (dados ? dados.length : 0) + ' propostas de teste.\n\nO backend est√° funcionando. Agora vou carregar todas as propostas...');
      carregar();
    })
    .withFailureHandler(err => {
      console.error('üß™ TESTE FALHOU!', err);
      debugLog('‚ùå TESTE FALHOU: ' + JSON.stringify(err), 'error');
      alert('‚ùå TESTE FALHOU!\n\n' + err + '\n\nVerifique o console do navegador (F12) e os logs do Apps Script.');
    })
    .getPropostasTeste();
}

function gerarRelatorioComFiltros() {
  // Coletar filtros atuais
  const etapa = document.getElementById('filtroEtapa').value;
  const prob = document.getElementById('filtroProb').value;
  const cliente = document.getElementById('filtroCliente').value;
  const alerta = document.getElementById('filtroAlerta').value;
  const busca = document.getElementById('filtroBusca').value;

  // Verificar se h√° filtros aplicados
  const temFiltros = etapa || prob || cliente || alerta || busca || vendedorFiltro;

  if (!temFiltros) {
    alert('‚ö†Ô∏è Nenhum filtro aplicado!\n\nAplique filtros (etapa, probabilidade, vendedor, etc.) e clique novamente para gerar o relat√≥rio filtrado.');
    return;
  }

  // Descrever filtros
  const descricaoFiltros = [];
  if (vendedorFiltro) descricaoFiltros.push('Vendedor: ' + vendedorFiltro);
  if (etapa) descricaoFiltros.push('Etapa: ' + document.getElementById('filtroEtapa').selectedOptions[0].text);
  if (prob) descricaoFiltros.push('Probabilidade: ' + document.getElementById('filtroProb').selectedOptions[0].text);
  if (cliente) descricaoFiltros.push('Cliente: ' + document.getElementById('filtroCliente').selectedOptions[0].text);
  if (alerta) descricaoFiltros.push('Alerta: ' + document.getElementById('filtroAlerta').selectedOptions[0].text);
  if (busca) descricaoFiltros.push('Busca: "' + busca + '"');

  const confirmacao = confirm(
    'üìä Gerar relat√≥rio com os seguintes filtros?\n\n' +
    descricaoFiltros.join('\n') +
    '\n\nO relat√≥rio ser√° gerado em uma nova janela.'
  );

  if (!confirmacao) return;

  // Pegar lista filtrada atual (que j√° est√° sendo exibida)
  let lista = [...propostas];

  // Aplicar mesmos filtros que aplicarFiltros()
  if (vendedorFiltro) lista = lista.filter(p => p.vendedor === vendedorFiltro);
  if (etapa) lista = lista.filter(p => p.etapa === etapa);
  if (prob === 'alta') lista = lista.filter(p => p.prob >= 70);
  else if (prob === 'media') lista = lista.filter(p => p.prob >= 40 && p.prob < 70);
  else if (prob === 'baixa') lista = lista.filter(p => p.prob < 40);
  if (cliente === 'recorrente') lista = lista.filter(p => p.historicoCliente && p.historicoCliente.ganhas > 0);
  else if (cliente === 'novo') lista = lista.filter(p => !p.historicoCliente || p.historicoCliente.ganhas === 0);
  else if (cliente === 'fiel') lista = lista.filter(p => p.historicoCliente && p.historicoCliente.ganhas >= 3);
  if (alerta === 'vencida') lista = lista.filter(p => Array.isArray(p.alertas) && p.alertas.some(a => a.tipo === 'VENCIDA' || a.tipo.startsWith('VENCE ')));
  else if (alerta === 'semcontato') lista = lista.filter(p => Array.isArray(p.alertas) && p.alertas.some(a => a.tipo.includes('SEM CONTATO')));
  else if (alerta === 'atrasada') lista = lista.filter(p => Array.isArray(p.alertas) && p.alertas.some(a => a.tipo === 'A√á√ÉO ATRASADA'));
  else if (alerta === 'estagnada') lista = lista.filter(p => Array.isArray(p.alertas) && p.alertas.some(a => a.tipo === 'PROPOSTA ESTAGNADA'));
  if (busca) {
    const buscaLower = busca.toLowerCase();
    lista = lista.filter(p => {
      const cli = String(p.cliente || '').toLowerCase();
      const num = String(p.num || '').toLowerCase();
      return cli.includes(buscaLower) || num.includes(buscaLower);
    });
  }

  alert(
    'üìä Gerando relat√≥rio...\n\n' +
    'Total de propostas filtradas: ' + lista.length + '\n' +
    'Valor total: ' + fmt(lista.reduce((s, p) => s + (p.valor || 0), 0)) + '\n\n' +
    'O relat√≥rio ser√° exibido em uma nova janela.'
  );

  // Chamar backend para gerar relat√≥rio HTML com a lista filtrada
  google.script.run
    .withSuccessHandler(() => {
      console.log('Relat√≥rio gerado com sucesso');
    })
    .withFailureHandler(err => {
      alert('‚ùå Erro ao gerar relat√≥rio: ' + err);
    })
    .gerarRelatorioComFiltrosAplicados(lista, descricaoFiltros.join(' | '));
}

// ==================== DASHBOARD ====================
function mostrarDashboard() {
  document.getElementById('modalDashboard').classList.add('aberto');
  document.getElementById('dashboardBody').innerHTML = '<div class="loading"><div class="loading-spinner"></div> Carregando dados do dashboard...</div>';

  // Carregar dados
  google.script.run
    .withSuccessHandler(renderDashboard)
    .withFailureHandler(err => {
      document.getElementById('dashboardBody').innerHTML = `<div style="text-align:center;padding:40px;color:#e74c3c">
        <div style="font-size:48px;margin-bottom:20px">‚ùå</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:10px">Erro ao carregar dashboard</div>
        <div style="font-size:14px;color:#666">${err}</div>
      </div>`;
    })
    .getDadosDashboard();
}

function fecharDashboard() {
  document.getElementById('modalDashboard').classList.remove('aberto');
}

function renderDashboard(dados) {
  console.log('üìä renderDashboard() chamada');
  console.log('Tipo de dados:', typeof dados);
  console.log('Dados completos:', JSON.stringify(dados, null, 2));

  if (!dados) {
    console.error('‚ùå Dados vazios ou nulos');
    document.getElementById('dashboardBody').innerHTML = '<div style="text-align:center;padding:40px">‚ùå Nenhum dado dispon√≠vel</div>';
    return;
  }

  console.log('‚úÖ Estrutura dos dados:');
  console.log('  - Total Propostas:', dados.totalPropostas);
  console.log('  - Vendedores:', dados.vendedores ? dados.vendedores.length : 0);
  console.log('  - Estados:', dados.estados ? dados.estados.length : 0);
  console.log('  - Funil keys:', dados.funil ? Object.keys(dados.funil) : []);
  console.log('  - Evolu√ß√£o Temporal:', dados.evolucaoTemporal ? dados.evolucaoTemporal.length : 0);
  console.log('  - Produtos:', dados.produtos ? dados.produtos.length : 0);

  const html = `
    <style>
      .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
      .dash-card { background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-radius: 12px; padding: 20px; border: 1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
      .dash-card-title { font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; letter-spacing: 0.5px; }
      .dash-card-value { font-size: 32px; font-weight: 700; color: #1a1a2e; margin-bottom: 4px; }
      .dash-card-label { font-size: 11px; color: #666; }
      .dash-section { margin-bottom: 40px; }
      .dash-section-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1a1a2e; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #4361ee; padding-bottom: 10px; }
      .chart-container { background: #fff; border-radius: 12px; padding: 25px; border: 1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
      .chart-canvas-wrapper { position: relative; height: 350px; }
      .chart-canvas-wrapper-lg { position: relative; height: 450px; }
      .debug-panel { background: #f0f0f0; border: 2px solid #666; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-family: monospace; font-size: 11px; max-height: 300px; overflow-y: auto; }
    </style>

    <!-- DEBUG PANEL (Bot√£o discreto no canto) -->
    <div style="position:fixed;top:70px;right:10px;z-index:9999">
      <button onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'"
              style="background:#6c757d;color:white;border:none;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.2)">
        üîç Debug
      </button>
      <div style="display:none;position:absolute;right:0;top:35px;background:white;border:2px solid #6c757d;padding:15px;border-radius:8px;max-width:400px;max-height:400px;overflow:auto;box-shadow:0 4px 12px rgba(0,0,0,0.3);font-size:11px">
        <strong>üêõ DEBUG - Dados Recebidos:</strong><br>
        Total Propostas: ${dados.totalPropostas || 'N/A'}<br>
        Vendedores: ${dados.vendedores ? dados.vendedores.length : 'N/A'}<br>
        Estados: ${dados.estados ? dados.estados.length : 'N/A'}<br>
        Funil: ${dados.funil ? JSON.stringify(Object.keys(dados.funil)) : 'N/A'}<br>
        Evolu√ß√£o Temporal: ${dados.evolucaoTemporal ? dados.evolucaoTemporal.length + ' meses' : 'N/A'}<br>
        Produtos: ${dados.produtos ? dados.produtos.length : 'N/A'}<br>
        <details style="margin-top:10px">
          <summary style="cursor:pointer;color:#4361ee">Ver JSON completo</summary>
          <pre style="font-size:10px;max-height:200px;overflow:auto;background:#f5f5f5;padding:8px;border-radius:4px;margin-top:5px">${JSON.stringify(dados, null, 2)}</pre>
        </details>
      </div>
    </div>

    <!-- M√âTRICAS PRINCIPAIS -->
    <div class="dash-grid">
      <div class="dash-card" style="border-left: 4px solid #4361ee;">
        <div class="dash-card-title">üìä Total Propostas</div>
        <div class="dash-card-value">${dados.totalPropostas}</div>
        <div class="dash-card-label">
          <span style="color:#16a34a">‚úÖ ${dados.ganhas} ganhas</span> |
          <span style="color:#dc2626">‚ùå ${dados.perdidas} perdidas</span> |
          <span style="color:#4361ee">üîÑ ${dados.ativas} ativas</span>
        </div>
      </div>

      <div class="dash-card" style="border-left: 4px solid #16a34a;">
        <div class="dash-card-title">üí∞ Pipeline Total</div>
        <div class="dash-card-value" style="color:#4361ee">${fmt(dados.valorTotal)}</div>
        <div class="dash-card-label">
          <span style="color:#16a34a">Ganho: ${fmt(dados.valorGanho)}</span><br>
          <span style="color:#4361ee">Ativo: ${fmt(dados.valorAtivo)}</span>
        </div>
      </div>

      <div class="dash-card" style="border-left: 4px solid #f39c12;">
        <div class="dash-card-title">üìà Taxa de Convers√£o</div>
        <div class="dash-card-value" style="color:#16a34a">${dados.taxaConversao}%</div>
        <div class="dash-card-label">${dados.ganhas} fechadas de ${dados.totalPropostas} propostas</div>
      </div>

      <div class="dash-card" style="border-left: 4px solid #9333ea;">
        <div class="dash-card-title">üí≥ Ticket M√©dio</div>
        <div class="dash-card-value" style="font-size:24px">${fmt(dados.ticketMedio)}</div>
        <div class="dash-card-label">M√©dia por proposta</div>
      </div>

      <div class="dash-card" style="border-left: 4px solid #e74c3c;">
        <div class="dash-card-title">üö® Urgentes</div>
        <div class="dash-card-value" style="color:#e74c3c">${dados.urgentes}</div>
        <div class="dash-card-label">Propostas com alertas cr√≠ticos</div>
      </div>

      <div class="dash-card" style="border-left: 4px solid #f59e0b;">
        <div class="dash-card-title">üìû Sem Contato</div>
        <div class="dash-card-value" style="color:#f59e0b">${dados.semContato}</div>
        <div class="dash-card-label">Mais de 7 dias sem intera√ß√£o</div>
      </div>

      <div class="dash-card" style="border-left: 4px solid #dc2626;">
        <div class="dash-card-title">‚è∞ Vencidas</div>
        <div class="dash-card-value" style="color:#dc2626">${dados.vencidas}</div>
        <div class="dash-card-label">Propostas com validade expirada</div>
      </div>

      <div class="dash-card" style="border-left: 4px solid #10b981;">
        <div class="dash-card-title">‚ö° Alta Probabilidade</div>
        <div class="dash-card-value" style="color:#10b981">${dados.probabilidade.alta}</div>
        <div class="dash-card-label">${fmt(dados.probabilidade.valorAlta)} em valor</div>
      </div>
    </div>

    <!-- GRID DE GR√ÅFICOS -->
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:25px;margin-bottom:30px">

      <!-- FUNIL DE VENDAS -->
      <div class="chart-container">
        <div class="dash-section-title" style="border:none;margin-bottom:15px">üéØ Funil de Vendas</div>
        <div class="chart-canvas-wrapper">
          <canvas id="chartFunil"></canvas>
        </div>
      </div>

      <!-- AN√ÅLISE DE PROBABILIDADE -->
      <div class="chart-container">
        <div class="dash-section-title" style="border:none;margin-bottom:15px">üé≤ Probabilidade</div>
        <div class="chart-canvas-wrapper">
          <canvas id="chartProbabilidade"></canvas>
        </div>
      </div>
    </div>

    <!-- EVOLU√á√ÉO TEMPORAL -->
    <div class="chart-container" style="margin-bottom:30px">
      <div class="dash-section-title" style="border:none;margin-bottom:15px">üìÖ Evolu√ß√£o Temporal (√öltimos 12 Meses)</div>
      <div class="chart-canvas-wrapper">
        <canvas id="chartEvolucao"></canvas>
      </div>
    </div>

    <!-- PERFORMANCE VENDEDORES E MAPA DO BRASIL -->
    <div style="display:grid;grid-template-columns:1fr 1.2fr;gap:25px;margin-bottom:30px">

      <div class="chart-container">
        <div class="dash-section-title" style="border:none;margin-bottom:15px">üë• Top 10 Vendedores</div>
        <div class="chart-canvas-wrapper-lg">
          <canvas id="chartVendedores"></canvas>
        </div>
      </div>

      <!-- MAPA INTERATIVO DO BRASIL -->
      <div class="chart-container">
        <div class="dash-section-title" style="border:none;margin-bottom:15px">üáßüá∑ Mapa do Brasil - Distribui√ß√£o por Estado</div>
        <div style="position:relative;height:450px;display:flex;align-items:center;justify-content:center">
          <div id="mapaBrasil" style="width:100%;height:100%;position:relative"></div>
        </div>
      </div>
    </div>

    <!-- ESTADOS E PRODUTOS -->
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:25px;margin-bottom:30px">

      <div class="chart-container">
        <div class="dash-section-title" style="border:none;margin-bottom:15px">üó∫Ô∏è Top 10 Estados</div>
        <div class="chart-canvas-wrapper-lg">
          <canvas id="chartEstados"></canvas>
        </div>
      </div>

      <div class="chart-container">
        <div class="dash-section-title" style="border:none;margin-bottom:15px">üì¶ Top 10 Produtos</div>
        <div class="chart-canvas-wrapper-lg">
          <canvas id="chartProdutos"></canvas>
        </div>
      </div>
    </div>

    <!-- DETALHES POR ESTADO (TABELA COMPLETA) -->
    <div class="chart-container" style="margin-bottom:30px">
      <div class="dash-section-title" style="border:none;margin-bottom:15px">üìä An√°lise Detalhada por Estado</div>
      <div id="tabelaEstadosDetalhada"></div>
    </div>

    <div style="text-align:center;padding:20px;background:#f8f9fa;border-radius:8px">
      <div style="font-size:11px;color:#888">
        üìä Dashboard gerado em ${new Date().toLocaleString('pt-BR')} | Atualizado a cada sincroniza√ß√£o
      </div>
    </div>
  `;

  document.getElementById('dashboardBody').innerHTML = html;

  // Aguardar renderiza√ß√£o do DOM antes de criar os gr√°ficos
  setTimeout(() => {
    criarGraficosDashboard(dados);
  }, 100);
}

// Fun√ß√£o para criar todos os gr√°ficos Chart.js
function criarGraficosDashboard(dados) {
  console.log('üé® criarGraficosDashboard() iniciada');
  console.log('Dados recebidos:', dados);

  // Criar painel de status visual (oculto por padr√£o, mostra apenas erros)
  let debugContainer = document.getElementById('debugGraficosStatus');
  let hasErrors = false;

  if (!debugContainer) {
    debugContainer = document.createElement('div');
    debugContainer.id = 'debugGraficosStatus';
    debugContainer.style.cssText = 'position:fixed;bottom:10px;right:10px;background:#1a1a2e;color:#fff;padding:15px;border-radius:8px;max-width:400px;max-height:300px;overflow-y:auto;z-index:10000;font-size:11px;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:none;';
    debugContainer.innerHTML = '<div style="font-weight:bold;margin-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:5px;">üîç DEBUG</div>';
    document.body.appendChild(debugContainer);
  }

  function addDebugMsg(msg, tipo = 'info') {
    const cores = { info: '#4a9eff', success: '#27ae60', error: '#e74c3c', warn: '#f39c12' };
    const icones = { info: '‚ÑπÔ∏è', success: '‚úÖ', error: '‚ùå', warn: '‚ö†Ô∏è' };

    // Mostrar painel apenas se houver erro ou aviso
    if (tipo === 'error' || tipo === 'warn') {
      hasErrors = true;
      debugContainer.style.display = 'block';
    }

    debugContainer.innerHTML += `<div style="margin:3px 0;padding:5px;background:rgba(255,255,255,0.05);border-left:3px solid ${cores[tipo]};border-radius:3px;">${icones[tipo]} ${msg}</div>`;
    debugContainer.scrollTop = debugContainer.scrollHeight;
  }

  addDebugMsg('Iniciando cria√ß√£o de gr√°ficos...', 'info');

  if (!dados) {
    addDebugMsg('ERRO: Dados vazios!', 'error');
    return;
  }

  addDebugMsg(`Total Propostas: ${dados.totalPropostas}`, 'info');
  addDebugMsg(`Vendedores: ${dados.vendedores ? dados.vendedores.length : 0}`, 'info');
  addDebugMsg(`Estados: ${dados.estados ? dados.estados.length : 0}`, 'info');

  // Destruir gr√°ficos existentes se houver
  if (window.dashCharts) {
    Object.values(window.dashCharts).forEach(chart => {
      if (chart) chart.destroy();
    });
  }
  window.dashCharts = {};

  // 1. FUNIL DE VENDAS - Horizontal Bar
  const ctxFunil = document.getElementById('chartFunil');
  addDebugMsg('Criando gr√°fico Funil...', 'info');

  if (ctxFunil) {
    try {
      const funilLabels = Object.values(dados.funil).map(e => e.label);
      const funilCounts = Object.values(dados.funil).map(e => e.count);
      const funilColors = Object.values(dados.funil).map(e => e.cor);

      addDebugMsg(`Funil: ${funilLabels.length} etapas`, 'info');

      window.dashCharts.funil = new Chart(ctxFunil, {
        type: 'bar',
        data: {
          labels: funilLabels,
          datasets: [{
            label: 'Propostas',
            data: funilCounts,
            backgroundColor: funilColors,
            borderColor: funilColors.map(c => c.replace('0.8', '1')),
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                afterLabel: (ctx) => {
                  const etapa = Object.values(dados.funil)[ctx.dataIndex];
                  return `Valor: ${fmt(etapa.valor)}`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)' }
            },
            y: {
              grid: { display: false }
            }
          }
        }
      });
      addDebugMsg('Funil criado!', 'success');
    } catch (e) {
      addDebugMsg(`ERRO Funil: ${e.message}`, 'error');
    }
  } else {
    addDebugMsg('Canvas Funil n√£o encontrado!', 'error');
  }

  // 2. PROBABILIDADE - Doughnut
  const ctxProb = document.getElementById('chartProbabilidade');
  addDebugMsg('Criando gr√°fico Probabilidade...', 'info');

  if (ctxProb) {
    try {
      window.dashCharts.probabilidade = new Chart(ctxProb, {
        type: 'doughnut',
        data: {
          labels: ['Alta (70%+)', 'M√©dia (40-69%)', 'Baixa (<40%)'],
          datasets: [{
            data: [dados.probabilidade.alta, dados.probabilidade.media, dados.probabilidade.baixa],
            backgroundColor: [
              'rgba(16, 185, 129, 0.8)',
              'rgba(245, 158, 11, 0.8)',
              'rgba(220, 38, 38, 0.8)'
            ],
            borderColor: ['#10b981', '#f59e0b', '#dc2626'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { padding: 15, font: { size: 12 } }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const valores = [dados.probabilidade.valorAlta, dados.probabilidade.valorMedia, dados.probabilidade.valorBaixa];
                  return `${ctx.label}: ${ctx.parsed} propostas (${fmt(valores[ctx.dataIndex])})`;
                }
              }
            }
          }
        }
      });
      addDebugMsg('Probabilidade criado!', 'success');
    } catch (e) {
      addDebugMsg(`ERRO Probabilidade: ${e.message}`, 'error');
    }
  } else {
    addDebugMsg('Canvas Probabilidade n√£o encontrado!', 'error');
  }

  // 3. EVOLU√á√ÉO TEMPORAL - Line
  const ctxEvolucao = document.getElementById('chartEvolucao');
  addDebugMsg('Criando gr√°fico Evolu√ß√£o...', 'info');

  if (ctxEvolucao) {
    try {
    const meses = dados.evolucaoTemporal.map(m => m.mes);

    window.dashCharts.evolucao = new Chart(ctxEvolucao, {
      type: 'line',
      data: {
        labels: meses,
        datasets: [
          {
            label: 'Criadas',
            data: dados.evolucaoTemporal.map(m => m.criadas),
            borderColor: '#4361ee',
            backgroundColor: 'rgba(67, 97, 238, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true
          },
          {
            label: 'Ganhas',
            data: dados.evolucaoTemporal.map(m => m.ganhas),
            borderColor: '#16a34a',
            backgroundColor: 'rgba(22, 163, 74, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true
          },
          {
            label: 'Perdidas',
            data: dados.evolucaoTemporal.map(m => m.perdidas),
            borderColor: '#dc2626',
            backgroundColor: 'rgba(220, 38, 38, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: { padding: 15, font: { size: 12, weight: '600' } }
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: {
            grid: { display: false }
          }
        }
      }
    });
      addDebugMsg('Evolu√ß√£o criado!', 'success');
    } catch (e) {
      addDebugMsg(`ERRO Evolu√ß√£o: ${e.message}`, 'error');
    }
  } else {
    addDebugMsg('Canvas Evolu√ß√£o n√£o encontrado!', 'error');
  }

  // 4. VENDEDORES - Horizontal Bar
  const ctxVendedores = document.getElementById('chartVendedores');
  addDebugMsg('Criando gr√°fico Vendedores...', 'info');

  if (ctxVendedores) {
    try {
      const top10Vendedores = dados.vendedores.slice(0, 10);

      window.dashCharts.vendedores = new Chart(ctxVendedores, {
      type: 'bar',
      data: {
        labels: top10Vendedores.map(v => v.nome.length > 20 ? v.nome.substring(0, 17) + '...' : v.nome),
        datasets: [
          {
            label: 'Valor Total',
            data: top10Vendedores.map(v => v.valor),
            backgroundColor: 'rgba(67, 97, 238, 0.8)',
            borderColor: '#4361ee',
            borderWidth: 2,
            borderRadius: 6,
            xAxisID: 'x'
          },
          {
            label: 'Ganhas',
            data: top10Vendedores.map(v => v.ganhas),
            backgroundColor: 'rgba(22, 163, 74, 0.8)',
            borderColor: '#16a34a',
            borderWidth: 2,
            borderRadius: 6,
            xAxisID: 'x1'
          }
        ]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: { padding: 10, font: { size: 11 } }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const vendedor = top10Vendedores[ctx.dataIndex];
                if (ctx.datasetIndex === 0) {
                  return `Valor: ${fmt(ctx.parsed.x)} | Taxa: ${vendedor.taxaConversao}%`;
                }
                return `Ganhas: ${ctx.parsed.x} | Ativas: ${vendedor.ativas} | Perdidas: ${vendedor.perdidas}`;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.05)' },
            ticks: {
              callback: (value) => fmt(value)
            }
          },
          x1: {
            type: 'linear',
            position: 'top',
            beginAtZero: true,
            grid: { display: false },
            ticks: {
              stepSize: 1,
              font: { size: 10 }
            }
          },
          y: {
            grid: { display: false }
          }
        }
      }
    });
      addDebugMsg('Vendedores criado!', 'success');
    } catch (e) {
      addDebugMsg(`ERRO Vendedores: ${e.message}`, 'error');
    }
  } else {
    addDebugMsg('Canvas Vendedores n√£o encontrado!', 'error');
  }

  // 5. ESTADOS - Horizontal Bar
  const ctxEstados = document.getElementById('chartEstados');
  addDebugMsg('Criando gr√°fico Estados...', 'info');

  if (ctxEstados) {
    try {
      const top10Estados = dados.estados.slice(0, 10);

      window.dashCharts.estados = new Chart(ctxEstados, {
      type: 'bar',
      data: {
        labels: top10Estados.map(e => e.estado),
        datasets: [{
          label: 'Valor Total',
          data: top10Estados.map(e => e.valor),
          backgroundColor: 'rgba(16, 185, 129, 0.8)',
          borderColor: '#10b981',
          borderWidth: 2,
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              afterLabel: (ctx) => {
                const estado = top10Estados[ctx.dataIndex];
                return `${estado.count} propostas | ${estado.ganhas} ganhas`;
              },
              label: (ctx) => `Valor: ${fmt(ctx.parsed.x)}`
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.05)' },
            ticks: {
              callback: (value) => fmt(value)
            }
          },
          y: {
            grid: { display: false }
          }
        }
      }
    });
      addDebugMsg('Estados criado!', 'success');
    } catch (e) {
      addDebugMsg(`ERRO Estados: ${e.message}`, 'error');
    }
  } else {
    addDebugMsg('Canvas Estados n√£o encontrado!', 'error');
  }

  // 6. PRODUTOS - Horizontal Bar
  const ctxProdutos = document.getElementById('chartProdutos');
  addDebugMsg('Criando gr√°fico Produtos...', 'info');

  if (ctxProdutos) {
    try {
      const top10Produtos = dados.produtos.slice(0, 10);

      window.dashCharts.produtos = new Chart(ctxProdutos, {
      type: 'bar',
      data: {
        labels: top10Produtos.map(p => {
          const nome = p.produto.length > 30 ? p.produto.substring(0, 27) + '...' : p.produto;
          return nome;
        }),
        datasets: [{
          label: 'Valor Total',
          data: top10Produtos.map(p => p.valor),
          backgroundColor: 'rgba(147, 51, 234, 0.8)',
          borderColor: '#9333ea',
          borderWidth: 2,
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (ctx) => top10Produtos[ctx[0].dataIndex].produto,
              afterLabel: (ctx) => {
                const prod = top10Produtos[ctx.dataIndex];
                const taxa = prod.count > 0 ? Math.round((prod.ganhas / prod.count) * 100) : 0;
                return `${prod.count} propostas | ${prod.ganhas} ganhas | ${taxa}% convers√£o`;
              },
              label: (ctx) => `Valor: ${fmt(ctx.parsed.x)}`
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.05)' },
            ticks: {
              callback: (value) => fmt(value)
            }
          },
          y: {
            grid: { display: false }
          }
        }
      }
    });
      addDebugMsg('Produtos criado!', 'success');
    } catch (e) {
      addDebugMsg(`ERRO Produtos: ${e.message}`, 'error');
    }
  } else {
    addDebugMsg('Canvas Produtos n√£o encontrado!', 'error');
  }

  // 7. MAPA DO BRASIL - SVG Interativo
  addDebugMsg('Criando Mapa do Brasil...', 'info');
  try {
    criarMapaBrasil(dados);
    addDebugMsg('Mapa do Brasil criado!', 'success');
  } catch (e) {
    addDebugMsg(`ERRO Mapa: ${e.message}`, 'error');
  }

  // 8. TABELA DETALHADA DE ESTADOS
  addDebugMsg('Criando Tabela de Estados...', 'info');
  try {
    criarTabelaEstadosDetalhada(dados);
    addDebugMsg('Tabela criada!', 'success');
  } catch (e) {
    addDebugMsg(`ERRO Tabela: ${e.message}`, 'error');
  }

  addDebugMsg('üéâ PROCESSO COMPLETO!', 'success');
}

// Fun√ß√£o para criar o mapa interativo do Brasil
function criarMapaBrasil(dados) {
  const container = document.getElementById('mapaBrasil');
  if (!container) return;

  // Mapeamento de siglas para nomes completos
  const siglaParaNome = {
    'AC': 'Acre', 'AL': 'Alagoas', 'AP': 'Amap√°', 'AM': 'Amazonas', 'BA': 'Bahia',
    'CE': 'Cear√°', 'DF': 'Distrito Federal', 'ES': 'Esp√≠rito Santo', 'GO': 'Goi√°s',
    'MA': 'Maranh√£o', 'MT': 'Mato Grosso', 'MS': 'Mato Grosso do Sul', 'MG': 'Minas Gerais',
    'PA': 'Par√°', 'PB': 'Para√≠ba', 'PR': 'Paran√°', 'PE': 'Pernambuco', 'PI': 'Piau√≠',
    'RJ': 'Rio de Janeiro', 'RN': 'Rio Grande do Norte', 'RS': 'Rio Grande do Sul',
    'RO': 'Rond√¥nia', 'RR': 'Roraima', 'SC': 'Santa Catarina', 'SP': 'S√£o Paulo',
    'SE': 'Sergipe', 'TO': 'Tocantins'
  };

  // Criar mapeamento de dados por estado
  const dadosPorEstado = {};
  const maxValor = Math.max(...dados.estados.map(e => e.valor), 1);

  dados.estados.forEach(e => {
    let sigla = null;
    let nome = null;

    // Verificar se e.estado √© uma sigla (2 caracteres) ou nome completo
    if (e.estado && e.estado.length === 2) {
      // √â uma sigla - usar diretamente
      sigla = e.estado.toUpperCase();
      nome = siglaParaNome[sigla] || e.estado;
    } else {
      // √â um nome completo - procurar a sigla correspondente
      sigla = Object.keys(siglaParaNome).find(k => siglaParaNome[k] === e.estado);
      nome = e.estado;
    }

    if (sigla && siglaParaNome[sigla]) {
      dadosPorEstado[sigla] = {
        nome: nome,
        count: e.count,
        ganhas: e.ganhas,
        valor: e.valor,
        intensidade: e.valor / maxValor
      };
    }
  });

  // Fun√ß√£o para obter cor baseada na intensidade
  const getCor = (intensidade) => {
    if (intensidade === 0) return '#f0f0f0';
    const hue = 140; // Verde
    const saturation = 70 + (intensidade * 30);
    const lightness = 75 - (intensidade * 35);
    return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
  };

  // HTML do mapa simplificado do Brasil
  const mapaHTML = `
    <style>
      .mapa-brasil { width: 100%; height: 100%; position: relative; }
      .estado-info {
        position: absolute;
        background: rgba(0,0,0,0.85);
        color: #fff;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      }
      .estado-box {
        display: inline-block;
        padding: 6px 10px;
        margin: 3px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 11px;
        font-weight: 600;
        border: 2px solid transparent;
      }
      .estado-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        border-color: #4361ee;
      }
      .regiao-grupo {
        margin-bottom: 15px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
      }
      .regiao-titulo {
        font-size: 13px;
        font-weight: 700;
        color: #4361ee;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
    </style>

    <div class="mapa-brasil">
      <div id="estadoTooltip" class="estado-info" style="display:none"></div>

      <div class="regiao-grupo">
        <div class="regiao-titulo">Norte</div>
        ${['AC', 'AP', 'AM', 'PA', 'RO', 'RR', 'TO'].map(sigla => {
          const dados = dadosPorEstado[sigla] || { intensidade: 0, count: 0 };
          return `<span class="estado-box" data-estado="${sigla}" style="background:${getCor(dados.intensidade)}">${sigla}</span>`;
        }).join('')}
      </div>

      <div class="regiao-grupo">
        <div class="regiao-titulo">Nordeste</div>
        ${['AL', 'BA', 'CE', 'MA', 'PB', 'PE', 'PI', 'RN', 'SE'].map(sigla => {
          const dados = dadosPorEstado[sigla] || { intensidade: 0, count: 0 };
          return `<span class="estado-box" data-estado="${sigla}" style="background:${getCor(dados.intensidade)}">${sigla}</span>`;
        }).join('')}
      </div>

      <div class="regiao-grupo">
        <div class="regiao-titulo">Centro-Oeste</div>
        ${['DF', 'GO', 'MT', 'MS'].map(sigla => {
          const dados = dadosPorEstado[sigla] || { intensidade: 0, count: 0 };
          return `<span class="estado-box" data-estado="${sigla}" style="background:${getCor(dados.intensidade)}">${sigla}</span>`;
        }).join('')}
      </div>

      <div class="regiao-grupo">
        <div class="regiao-titulo">Sudeste</div>
        ${['ES', 'MG', 'RJ', 'SP'].map(sigla => {
          const dados = dadosPorEstado[sigla] || { intensidade: 0, count: 0 };
          return `<span class="estado-box" data-estado="${sigla}" style="background:${getCor(dados.intensidade)}">${sigla}</span>`;
        }).join('')}
      </div>

      <div class="regiao-grupo">
        <div class="regiao-titulo">Sul</div>
        ${['PR', 'RS', 'SC'].map(sigla => {
          const dados = dadosPorEstado[sigla] || { intensidade: 0, count: 0 };
          return `<span class="estado-box" data-estado="${sigla}" style="background:${getCor(dados.intensidade)}">${sigla}</span>`;
        }).join('')}
      </div>

      <div style="margin-top:15px;padding:10px;background:#fff;border-radius:6px;font-size:10px;text-align:center;color:#666">
        <strong>Legenda:</strong> Cor mais escura = maior volume de vendas | Hover para detalhes
      </div>
    </div>
  `;

  container.innerHTML = mapaHTML;

  // Adicionar interatividade
  const estadoBoxes = container.querySelectorAll('.estado-box');
  const tooltip = container.querySelector('#estadoTooltip');

  estadoBoxes.forEach(box => {
    box.addEventListener('mouseenter', (e) => {
      const sigla = e.target.dataset.estado;
      const dados = dadosPorEstado[sigla];

      if (dados) {
        tooltip.innerHTML = `
          <strong style="font-size:14px">${dados.nome} (${sigla})</strong><br>
          <span style="color:#10b981">üí∞ ${fmt(dados.valor)}</span><br>
          <span style="color:#fff">üìä ${dados.count} propostas</span><br>
          <span style="color:#4ade80">‚úÖ ${dados.ganhas} ganhas</span>
        `;
      } else {
        tooltip.innerHTML = `
          <strong style="font-size:14px">${siglaParaNome[sigla]} (${sigla})</strong><br>
          <span style="color:#999">Sem dados</span>
        `;
      }

      tooltip.style.display = 'block';
      tooltip.style.left = (e.pageX - container.getBoundingClientRect().left + 15) + 'px';
      tooltip.style.top = (e.pageY - container.getBoundingClientRect().top - 10) + 'px';
    });

    box.addEventListener('mousemove', (e) => {
      tooltip.style.left = (e.pageX - container.getBoundingClientRect().left + 15) + 'px';
      tooltip.style.top = (e.pageY - container.getBoundingClientRect().top - 10) + 'px';
    });

    box.addEventListener('mouseleave', () => {
      tooltip.style.display = 'none';
    });

    box.addEventListener('click', (e) => {
      const sigla = e.target.dataset.estado;
      const dados = dadosPorEstado[sigla];
      if (dados) {
        alert(`üìä ${dados.nome}\n\nüí∞ Valor Total: ${fmt(dados.valor)}\nüìà Propostas: ${dados.count}\n‚úÖ Ganhas: ${dados.ganhas}\nüìä Taxa Convers√£o: ${dados.count > 0 ? Math.round((dados.ganhas / dados.count) * 100) : 0}%`);
      }
    });
  });
}

// Fun√ß√£o para criar tabela detalhada de estados
function criarTabelaEstadosDetalhada(dados) {
  const container = document.getElementById('tabelaEstadosDetalhada');
  if (!container) return;

  const html = `
    <div style="overflow-x:auto">
      <table class="table-dash">
        <thead>
          <tr>
            <th style="text-align:left">Estado</th>
            <th style="text-align:center">Total</th>
            <th style="text-align:center">Ativas</th>
            <th style="text-align:center">Ganhas</th>
            <th style="text-align:center">Perdidas</th>
            <th style="text-align:right">Valor Total</th>
            <th style="text-align:right">Valor Ganho</th>
            <th style="text-align:right">Ticket M√©dio</th>
            <th style="text-align:center">Taxa Convers√£o</th>
          </tr>
        </thead>
        <tbody>
          ${dados.estados.map((e, idx) => {
            const taxaConversao = e.count > 0 ? Math.round((e.ganhas / e.count) * 100) : 0;
            const ticketMedio = e.count > 0 ? e.valor / e.count : 0;
            const ativas = e.count - e.ganhas - (e.perdidas || 0);

            return `
              <tr style="${idx % 2 === 0 ? 'background:#f8f9fa' : ''}">
                <td style="font-weight:700;color:#4361ee">${escapeHtml(e.estado)}</td>
                <td style="text-align:center;font-weight:600">${e.count}</td>
                <td style="text-align:center"><span class="badge-yellow">${ativas >= 0 ? ativas : 0}</span></td>
                <td style="text-align:center"><span class="badge-green">${e.ganhas}</span></td>
                <td style="text-align:center"><span class="badge-red">${e.perdidas || 0}</span></td>
                <td style="text-align:right;font-weight:700;color:#4361ee">${fmt(e.valor)}</td>
                <td style="text-align:right;color:#16a34a;font-weight:600">${fmt(e.valorGanho || 0)}</td>
                <td style="text-align:right;color:#9333ea">${fmt(ticketMedio)}</td>
                <td style="text-align:center">
                  <span class="badge-${taxaConversao >= 30 ? 'green' : taxaConversao >= 15 ? 'yellow' : 'red'}">
                    ${taxaConversao}%
                  </span>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
        <tfoot>
          <tr style="background:#e0e7ff;font-weight:700">
            <td>TOTAL GERAL</td>
            <td style="text-align:center">${dados.estados.reduce((s, e) => s + e.count, 0)}</td>
            <td style="text-align:center;color:#f59e0b">${dados.ativas}</td>
            <td style="text-align:center;color:#16a34a">${dados.ganhas}</td>
            <td style="text-align:center;color:#dc2626">${dados.perdidas}</td>
            <td style="text-align:right;color:#4361ee">${fmt(dados.valorTotal)}</td>
            <td style="text-align:right;color:#16a34a">${fmt(dados.valorGanho)}</td>
            <td style="text-align:right;color:#9333ea">${fmt(dados.ticketMedio)}</td>
            <td style="text-align:center;color:#16a34a">${dados.taxaConversao}%</td>
          </tr>
        </tfoot>
      </table>
    </div>
  `;

  container.innerHTML = html;
}
</script>
</body>
</html>
